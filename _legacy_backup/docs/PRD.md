# 产品PRD

# # **1. 背景与目标（Why）**

## **1.1 背景（Background）**

在人力外包行业中，员工合同、证件、证书、项目周期等事项的到期管理经常高度依赖人工记录（Excel / 手写 / 微信日程），极易出现漏记、晚记、重复记的情况。

合同到期提醒尤其关键，一旦未续签及时处理，可能导致：

- 合同断档
- 法律风险增加
- 人力成本剧烈上升
- 项目组与外包公司之间的协调混乱
- 绩效考核与合规流程出问题

现有工具（如手机日历、备忘录、企业 OA）不支持**批量导入**、**多次提醒**、**月历可视化**，导致项目成员需要重复、低效地手动维护提醒信息。

因此需要一个简单但强大的系统来统一管理提醒。

---

## **1.2 要解决的核心问题（Problem Statement）**

1. **合同/证件/关键事项容易忘记，人工维护不可靠**
2. **没有可视化日历无法直观看到未来几周的到期风险**
3. **没有批量导入功能，重复录入耗时且容易出错**
4. **提醒不够及时（手机日历只能单提醒）**
5. **客户希望多个提前提醒（7 天、3 天、1 天）、且不漏提醒**

---

## **1.3 为什么现在必须做（Why Now）**

- 项目组已进入人员规模增长阶段，合同量迅速增加
- 人力流动加速，人工管理成本上涨
- 公司推进“数字化工具”方向，需要降低人工风险
- 频繁发生“到期未续签”的情况，已经造成管理隐患

---

## **1.4 产品目标（Product Goals）**

### 🎯 核心目标

1. **让所有合同、任务、事件的到期信息在月历中直观呈现**
2. **通过 Web Push 提前多次提醒，确保不漏提醒**
3. **支持 CSV 批量导入，减少 90% 的手工录入**
4. **支持事件的标签、搜索、筛选，快速定位重要事项**

### 🎯 间接目标

- 让项目组建立统一的提醒系统
- 降低管理风险与重复沟通成本
- 提升团队协作效率

---

## **1.5 成功指标（Success Metrics）**

| 指标 | 目标值 |
| --- | --- |
| 批量导入 CSV 的成功率 | ≥ 95% |
| 用户成功收到 Web Push 通知率 | ≥ 90% |
| 用户手动创建事件耗时 | < 10 秒 |
| 查询某人事件的平均用时 | < 5 秒 |
| 事件漏提醒率 | < 5% |

---

# # **2. 用户画像与用户故事（Who / What）**

## **2.1 用户画像（Personas）**

---

### 👤 **Persona 1：项目助理（Primary User）**

- 年龄：22–30
- 负责外包人员合同、证件、档案管理
- 对技术熟悉度中等
- 每天处理大量 Excel、人员信息
- 最担心：漏记合同到期、被主管问责

**需求重点：**

- 批量导入合同到期
- 多次提醒
- 快速搜索人员信息
- 可视化查看本月到期热点

---

### 👤 Persona 2：项目主管（Secondary User）

- 关注项目风险
- 偶尔查看“未来 30 天到期”
- 不需要录入，但需要查看

**需求重点：**

- 筛选、搜索
- 查看风险高度集中的几天
- 收到关键提醒（如提前 7 天）

---

### 👤 Persona 3：人力（Support User）

- 需要导出、核对合同信息
- 偶尔导入大量人员信息

需求重点：

- CSV 导入导出
- 数据准确性

---

## **2.2 用户故事（User Stories）**

以下是符合 “As a… I want… so that…” 模式的用户故事。

---

### 📝 **新增事件**

作为 **项目助理**，

我希望可以在日历上长按某一天新增事项，

以便快速记录合同到期或任务。

---

### 📝 **批量导入事件**

作为 **项目助理**，

我希望通过 CSV 文件一次性导入大量人员合同到期日，

从而避免繁琐的手工录入。

---

### 📝 **多次提醒**

作为 **项目助理或主管**，

我希望对于重要合同能提前 7 天、3 天、1 天收到浏览器推送提醒，

以确保不会错过续签时机。

---

### 📝 **日历查看**

作为 **项目助理或主管**，

我希望通过月历形式快速查看某一天的所有事件，

从而了解未来的工作压力与风险热点。

---

### 📝 **搜索**

作为 **项目助理**，

我希望能够按员工姓名、标签搜索事件，

以快速找到某人的合同情况。

---

### 📝 **标签分类**

作为 **项目助理**，

我希望能给事件打上如“合同”“证件”“到期”等标签，

便于管理不同类别的提醒。

---

### 📝 **Web Push 通知**

作为 **项目助理**，

我希望无论浏览器是否打开都能收到提醒，

以确保不会遗漏重要事项。

# # **3. 功能需求（Functional Requirements）**

本章定义系统在“用户看得到、能操作到”的层面必须具备的行为，包括：登录、月历视图、事件管理、CSV 导入、提醒规则、Web Push 通知、搜索筛选以及设置页面。任何实现细节（框架、数据库、API）都应在后续架构文档中体现，但不得与本章要求冲突。

---

## 3.1 功能范围总览（Scope Overview）

系统围绕一个核心场景展开：

> 以“合同到期日”为主的日程管理工具
> 
> 
> 用户在一个**月历视图**上管理大量“某一天要处理的合同/事项”，可以单条创建，也可以通过 CSV 批量导入；提醒逻辑不再分散在每条事件上，而是通过**“按标签统一配置的提醒规则”**来集中管理。
> 

### 3.1.1 In-Scope（本版本必须实现）

1. **用户认证**
    - Email + 密码注册 / 登录 / 登出
    - 登录后才能访问任何日历和事件数据
    - 每个用户的数据相互隔离
2. **月历视图（Monthly Calendar）**
    - 月视图网格展示
    - 每格显示当天事件摘要
    - 点击查看当天详情
    - 长按新增事件
    - 支持切换月份
3. **事件管理（Event Management）**
    - 新增 / 编辑 / 删除事件
    - 可选时间字段（主要是“哪一天”，不是“几点几分”）
    - 支持标签、备注
    - 支持拖拽调整日期（从 6 月 18 拖到 6 月 19）
4. **CSV 批量导入**
    - 从 CSV 文件中一次性导入大量事件
    - 导入时不设置提醒天数，只关心日期、标签等信息
    - 导入后自动基于标签应用统一提醒规则
5. **提醒规则（Reminder Rules）**
    - 在“设置页面”中为不同 label 定义“提前多少天提醒”
    - 如：`label = 合同` → 提前 `[7, 3, 1]` 天，每天上午 10:00（北京时间）提醒
    - 未配置规则时使用系统默认规则（提前 1 天，10:00 提醒）
6. **Web Push 通知**
    - 用户授权浏览器通知后，系统可在指定时间通过 Web Push 发送提醒
    - 即使用户没有打开页面（但浏览器支持 & 允许通知），依然能够收到
7. **搜索与筛选**
    - 按标题关键字搜索
    - 按标签筛选
8. **设置页面（Settings）**
    - 管理提醒规则（label → 提前多少天、提醒时间）
    - 管理 Web Push 订阅状态（开启/关闭、重新订阅）

---

### 3.1.2 Out-of-Scope（本版本明确不做）

- 重复事件（“每月 5 号”“每年生日” 等 RRULE）
- Google Calendar / Outlook / iCloud 等外部日历同步
- 短信 / 邮件通知
- 手机原生 App 推送（APNs / FCM）
- 多角色权限（管理员/只读/审核员）
- 跨时区复杂支持（本版本只针对 **Asia/Shanghai**）

---

## 3.2 核心对象与概念（Domain Concepts）

### 3.2.1 事件（Event）

**定义：**

某个用户，在某一天，需要处理的一个事项（例如：某员工合同到期），可选时间点、标签和备注。

**字段意图：**

- 以“日期”为主：系统关心“哪一天要处理”，不是精确到分钟的排班工具；
- 时间是一个附加信息，主要用于你有特殊需求的少数事件。

> 产品结论：
> 
> - 对绝大多数合同类事件，只要“哪天到期” + 默认 10:00 提醒就足够
> - 极少数需要精确提醒的事件可以单独设置 time（例如上午 9:00）

---

### 3.2.2 标签（Label）

用于区分不同类型的事件，例如：

- 合同
- 证件
- 证书
- 项目里程碑

标签是提醒规则的绑定点：**按标签来配置提醒策略**。

---

### 3.2.3 提醒规则（Reminder Rule）

**定义：**

一套“统一对某类事件如何提醒”的配置，例如：

> 对所有 label=合同 的事件，
> 
> 
> 在事件日期前 7 天、3 天、1 天，每天上午 10:00（北京时间）各提醒一次。
> 

规则与事件之间的关系：

- 事件记录：**只保存 date、time、label** 等信息
- 提醒规则：**按 label 聚合配置 offsets & time**
- ReminderJob：真正的“某一刻要发一条提醒”的任务

---

### 3.2.4 提醒任务（Reminder Job）

系统内部实体，代表“一次具体的提醒动作”：

- 比如：2025-06-19 10:00，提醒“张三合同明天到期”。

用户不会直接操作 ReminderJob，但它是 Web Push 调度的基础对象。

---

## 3.3 功能模块详述

### 3.3.1 用户认证模块（Auth）

**目标：**

保证每个项目成员只能看到自己账户下的日历和事件。

**功能要求：**

1. 注册
    - 提交 Email + 密码
    - 密码校验简单：长度至少 6 位（无需复杂字符规则）
    - 注册成功后自动登录或跳转到登录页
2. 登录
    - 提交 Email + 密码
    - 校验成功后建立会话（如 Cookie / JWT）
    - 登录后跳转到月历页面
3. 登出
    - 清除会话（前后端）
    - 跳转到登录页
4. 未登录访问保护
    - 访问任何 `/app` 页面时未登录 → 自动跳转到登录页
    - API 必须验证当前用户身份

---

### 3.3.2 月历视图（Monthly Calendar View）

**目标：**

提供一目了然的月份总览，让用户快速识别：

“这个月/下个月哪些天有重要事项”。

**功能点：**

1. 月网格展示
    - 按自然月份显示（当前年月）
    - 支持上月 / 下月切换
    - 周起始日为周一（可在设置中未来支持修改）
2. 每日格子内容
    - 日期数字（如 18）
    - 当天事件列表（最多显示 2 条）：
        - 显示标签颜色小圆点（如合同=红，证件=蓝）
        - 显示简短标题（截断）
        - 若该事件有有效提醒规则 → 显示一个小铃铛图标
    - 超出 2 条时显示 “+X 个”
3. 交互
    - **点击某天**：右侧 / 弹窗打开该日事件列表
    - **长按某天（移动端） / 右键（桌面端）**：打开“新增事件”弹窗，日期自动填入
    - **拖拽事件**：将事件从某天拖动到另一天，松手后弹出确认提示（可撤销）

---

### 3.3.3 事件管理（Event CRUD）

**新增事件：**

- 入口：
    - 月历长按某天
    - 当日事件列表中的“新增”按钮
- 表单字段：
    - 标题（必填）
    - 日期（必填，默认选中那一天）
    - 时间（可选）
    - 标签（可选，下拉或可输入）
    - 备注（可选）
- 保存逻辑：
    - 将事件保存到后端
    - 根据事件标签和全局提醒规则生成 ReminderJobs
    - 更新月历视图

**编辑事件：**

- 入口：点击某日事件列表中的某条记录
- 内容：可以修改上述所有字段
- 保存后：
    - 更新 Event
    - 删除旧的 ReminderJobs，按最新规则重新生成

**删除事件：**

- 在事件详情中点击“删除”，需弹出确认
- 删除后：
    - 删除 Event
    - 删除与之相关的 ReminderJobs
    - 更新月历视图

**拖拽改日期：**

- 在月历中拖拽事件到新日期
- 松手后：
    - 更新 Event 的 date（和 datetime）
    - 重新生成 ReminderJobs
    - 支持 “撤销” 操作（短时间内）

---

### 3.3.4 CSV 批量导入（Bulk Import via CSV）

**设计原则：**

- 导入阶段只关心“**事件基础信息**”
- 提醒逻辑完全由**全局提醒规则**接管，不在每行为提醒单独设定 offset

**支持字段：**

- title（必填）
- date（必填）
- time（可选）
- label（可选）
- notes（可选）

**导入流程：**

1. 用户点击“批量导入 CSV”
2. 选择本地 CSV 文件
3. 前端使用 PapaParse 解析：
    - 自动识别列名（中英文别名）
    - 尝试宽容地解析日期
4. 显示“导入预览页面”：
    - 表格列表展示所有解析到的行
    - 用户可以：
        - 删除某行
        - 修改 title / date / time / label / notes
    - 显示解析错误的行并提示原因（如：日期无效）
5. 用户点击“确认导入”：
    - 前端将“清洗后的事件数组”发送到后端 API `/api/events/bulk-create`
6. 后端：
    - 为当前 userId 批量创建 Event
    - 根据每条事件的 label 查找 ReminderRule：
        - 有规则 → 生成相应的 ReminderJobs
        - 无规则 → 使用系统默认规则（提前 1 天，10:00 提醒）
    - 返回成功/失败统计

**注意：**

- **CSV 不再支持 per-row 的 reminder_offset 列**
    
    提醒策略完全由全局规则决定，让导入模板更简单、使用更一致。
    

---

### 3.3.5 提醒规则 & Web Push 系统（Reminder Rules & Notifications）

**目标：**

你不用“每一条事件想提醒几天前”，而是按事件标签**统一定义规则**，降低维护成本。

### A. 设置提醒规则

在“设置 → 提醒规则”页面，用户可以：

- 查看当前已配置的规则列表：
    - 例如：
        - 合同：提前 [7, 3, 1] 天，10:00
        - 证件：提前 [30, 7] 天，10:00
- 新增 / 编辑 / 删除某条规则：
    - 选择 label（或自定义输入新标签）
    - 配置 offsetsInDays（一个数组，如 [7, 3, 1]）
    - 配置 defaultTime（如 "10:00"）

### B. 默认提醒规则

如果事件满足以下任一情况：

- 没有标签
- 有标签但没有对应的 ReminderRule

则使用系统默认规则（本版本建议固定为）：

- 提前 1 天
- 提醒时间：**10:00，北京时间**

### C. 提醒时间生成逻辑

对于每条 Event：

1. 确定“基准日期”：`date`
2. 确定“提醒时间”：
    - 若 Event 有 time：使用该 time
    - 若 Event 无 time：
        - 使用其 label 对应规则里的 defaultTime
        - 若规则也没有设置 defaultTime，则使用系统默认："10:00"
3. 对 offsetsInDays 中的每一项 d：
    - 计算 fireDate = date - d 天
    - fireTime = fireDate + 对应时间（如 10:00，转为 DateTime）

生成对应的 ReminderJobs，供 Scheduler 扫描推送。

### D. Web Push 通知行为（对用户而言）

- 用户第一次登录后，系统提示：
    
    > “是否允许浏览器通知？用于合同到期提醒。”
    > 
- 用户允许后：
    - 浏览器注册 PushSubscription
    - 后端保存订阅信息
- 到某个 ReminderJob 的 fireTime：
    - 即使页面关闭，浏览器仍能收到通知（前提是浏览器支持、权限未被关闭）

**提醒内容示例：**

> 标题：合同到期提醒
> 
> 
> 内容：张三的外包合同将于明天到期，请确认是否续签。
> 
> 点击通知 → 打开系统中该事件详情页。
> 

---

### 3.3.6 搜索与筛选（Search & Filter）

**搜索：**

- 文本框输入关键字，在**标题和备注**中模糊匹配
- 搜索结果可以：
    - 在月历中高亮匹配事件
    - 或在一个列表视图中展示所有匹配事件（可按日期排序）

**筛选：**

- 按标签筛选：
    - 多选：可以同时勾选“合同”和“证件”
    - 未勾选任何标签时等于“全部标签”

搜索与筛选可以组合，例如：

- 标签=合同 + 关键字=张三 → 只显示张三合同相关事件

---

### 3.3.7 设置页面（Settings）

**设置页面至少包含：**

1. 提醒规则设置（详见 3.3.5）
2. 通知授权状态：
    - 显示当前浏览器通知权限（允许 / 拒绝 / 未询问）
    - 提供“重新请求通知权限”的入口（在允许浏览器策略范围内）
3. （可选）系统默认规则预览（只读或可编辑）

---

## 3.4 用户关键流程（User Flows）

> （这里你可以沿用我之前给你的 Mermaid 图，只是逻辑上已经与“统一提醒规则”对齐了：导入/新增时不设 offset，而是在后端按 label 套用 ReminderRule 生成 jobs。为了不重复太长，我就不再把图全贴一遍，保留在原 3.4 中即可。）
> 

---

## 3.5 边界与业务规则（Edge Cases & Business Rules）

挑核心的跟你需求强相关的：

1. **如果用户没有配置任何提醒规则**
    - 所有事件使用系统默认规则：提前 1 天，10:00 提醒
2. **事件日期早于今天**
    - 仍允许导入和保存，但只生成“未来时间”的 ReminderJobs（不会补之前漏掉的提醒）
3. **修改提醒规则后，对已存在事件的影响**
    - 需明确：
        - A：仅影响未来创建/修改的事件（简单）
        - B：立即重算所有已有事件的 ReminderJobs（更强但更复杂）
    - 建议：本版本采用 **A 模式**，即**新规则只作用于之后新增/更新的事件**，已有事件不自动变更
4. **删除某标签的提醒规则**
    - 之后新事件使用系统默认规则
    - 不自动清理既有 ReminderJobs（可以保留，保持历史一致性）
5. **浏览器拒绝通知权限**
    - 设置页面 & 首页显眼位置提示：“未开启通知，可能错过提醒”
6. **CSV 日期/格式错误**
    - 提示具体行号和错误原因
    - 错误行不导入，正确行可继续导入

# # **4. 非功能需求（NFR — Non-functional Requirements）**

本节定义系统在性能、安全性、可用性、兼容性、可靠性等方面必须满足的标准。这些是代码编写、架构评审、测试验收的基础指标。

---

## **4.1 性能（Performance）**

### 📌 API 性能目标

| 项目 | 目标 |
| --- | --- |
| 单次批量导入 CSV（≤ 2000 行） | 后端写入时间 ≤ 2 秒 |
| 获取某月日历数据 | 响应时间 ≤ 300ms（P90） |
| 事件创建/更新/删除 | ≤ 200ms（P90） |
| Web Push 发送任务调度 | 每分钟扫描一次，扫描时间 ≤ 100ms |

### 📌 浏览器前端性能目标

- 月历渲染切换（上一月/下一月）≤ **150ms**。
- 首页首次加载（login → calendar）≤ **1 秒**。
- 单月事件数量 ≤ 200 条时依然保持流畅。

### 📌 后端稳定性

- 支持单用户 ≤ 10,000 条事件（足够你未来 10 年使用）。
- ReminderJob 数据量可扩展至百万级（不影响扫描性能，需要索引）。

---

## **4.2 可用性（Usability）**

- 系统操作必须简单，不需要阅读教程即可使用。
- CSV 导入流程不超过 3 步。
- 新增事件弹窗表单在 10 秒内能完成一次录入。
- 标签管理、提醒规则必须易理解（不允许复杂配置界面）。
- Web Push 提醒需要清晰提示用户“已开启 / 未开启”。

---

## **4.3 安全性（Security）**

### 🔐 用户身份安全

- 密码必须使用 bcrypt 哈希存储（不允许明文密码）。
- 所有 API 必须验证 userId，不得允许访问他人数据（防止 IDOR）。
- 会话 Token（JWT 或 Cookie）必须为 httpOnly。

### 🔐 数据访问控制

- Event、ReminderRule、ReminderJob 必须都带 userId 并强制校验。
- 不能通过前端提交 “userId” 来操控数据库。

### 🔐 CSV 安全

- 前端解析 CSV，后端不接受任意文件路径。
- 防止 CSV 注入（如标题以 “=CMD()” 开头）。

### 🔐 Web Push 安全

- VAPID keys 存储于后端环境变量，不得泄露至前端。
- subscription 必须绑定 userId。

---

## **4.4 浏览器兼容性（Compatibility）**

| 功能 | Chrome | Edge | Firefox | Safari | iOS Safari |
| --- | --- | --- | --- | --- | --- |
| 月历页面 | ✔ | ✔ | ✔ | ✔ | ✔ |
| Web Push | ✔ | ✔ | ✔ | ✔（macOS 需 16+） | ✔（需添加到主屏幕） |
| Notification API | ✔ | ✔ | ✔ | ✔ | 部分限制 |

> iOS Safari 的要求：用户需将网页加入主屏幕以启用 Web Push。
> 

---

## **4.5 可靠性（Reliability）**

- Scheduler 每分钟运行一次，至少有一次补偿机制（retry）。
- Web Push 失败次数超过 3 次，自动标记 subscription 为无效。
- 浏览器关闭后仍能收到提醒（在支持的浏览器中）。

---

## **4.6 国际化 / 时区（Time Zone）**

- 本版本固定使用 **Asia/Shanghai（北京时间）**。
- 后端 DateTime 存储为 UTC。

---

## **4.7 可维护性（Maintainability）**

- 代码层级必须清晰分离（/app/api、/lib、/components）。
- 所有业务逻辑函数必须可测试（纯函数或易 mock）。
- 数据库 schema 改动必须走 migration。

# # **5. 数据结构（Data Model）**

本节给出系统核心数据模型，包括字段说明、格式、约束条件。

这是 PRD 最重要的工程部分之一，后续将在 Stage 2 转换为 Prisma Schema。

---

## **5.1 User（用户）**

```tsx
User {
  id: string
  email: string
  password: string           // bcrypt hash
  createdAt: Date
}

```

### 说明：

- 每个用户拥有自己的事件、提醒规则、订阅信息，无交叉。

---

## **5.2 Event（事件）**

```tsx
Event {
  id: string
  userId: string
  title: string             // 必填
  date: string              // YYYY-MM-DD（必填）
  time?: string             // HH:mm（可选）
  datetime: Date            // date+time 合成后的实际提醒时间点（UTC）
  label?: string            // 例如 “合同”，可为空
  notes?: string
  reminderRuleId?: string   // 使用哪条提醒规则
  createdAt: Date
}

```

### 数据约束

- title 不可为空
- date 必须是可解析的有效日期
- datetime 永远为可提醒的时间（自动计算）

---

## **5.3 ReminderRule（提醒规则）**

```tsx
ReminderRule {
  id: string
  userId: string
  label: string                    // 对应事件标签
  offsetsInDays: number[]          // 如 [7, 3, 1]
  defaultTime: string              // HH:mm （如 "10:00"）
  createdAt: Date
}

```

### 数据约束

- 一个用户的同一 label 只能有一条规则
- offsetsInDays 必须为非负整数数组
- defaultTime 必须匹配 HH:mm 格式

---

## **5.4 ReminderJob（提醒任务）**

```tsx
ReminderJob {
  id: string
  userId: string
  eventId: string
  fireTime: Date               // UTC 绝对触发时间
  sent: boolean                // 是否已发送
  createdAt: Date
}

```

### 业务规则

- fireTime ≤ 当前时间，并 sent=false → 应被 Scheduler 推送
- 一个 ReminderJob 表示“一次具体提醒动作”

---

## **5.5 PushSubscription（浏览器推送订阅）**

```tsx
PushSubscription {
  id: string
  userId: string
  endpoint: string
  p256dh: string
  auth: string
  createdAt: Date
}

```

### 规则：

- subscription 必须绑定 userId
- 如果 endpoint 无效 → 下次 push 自动标记为无效

---

## **5.6 校验规则（Validation Rules）**

| 字段 | 校验规则 |
| --- | --- |
| email | 必须是有效邮箱格式 |
| password | 长度 ≥ 6 |
| date | YYYY-MM-DD 格式；不可为无效日期 |
| time | HH:mm 格式或为空 |
| label | 字符串，长度 ≤ 30 |
| reminder offsets | 必须为数字数组，例如 [1, 3, 7] |
| defaultTime | HH:mm 格式 |

# # **6. 验收标准（Acceptance Criteria）**

本节定义“功能完成”的判断规则，同时为测试（QA/自动化）提供用例。

---

## **6.1 登录与认证**

**通过条件：**

- 能注册新用户，并自动或手动登录成功
- 使用错误密码时提示“账号或密码错误”
- 未登录访问月历页面 → 自动跳转到登录页
- 登出后，访问任何事件 API → 返回 401

---

## **6.2 月历视图（月历页面）**

**通过条件：**

- 显示当前月份
- 显示每天事件数量摘要（最多 2 条 + “+X”）
- 点击某天能查看当天事件
- 长按某天能新增事件
- 切换月份不超过 150ms

---

## **6.3 事件管理（Event CRUD）**

### 新增事件

- 用户填写标题+日期
- 若未填时间 → 自动指定“10:00 北京时间”
- 若标签有提醒规则 → 自动生成 ReminderJobs
- 保存后立即显示在月历中

### 编辑事件

- 修改日期或标签后 → 重新生成 ReminderJobs
- 更新时间、文本、备注 → 不丢失数据

### 删除事件

- 删除 Event → 对应 ReminderJobs 必须删除

---

## **6.4 CSV 批量导入**

**通过条件：**

- 能上传 CSV 并正确解析
- 错误行显示错误原因（如日期无效）
- 预览页面可删除行、可修改字段
- 点击导入后：
    - Event 批量写入数据库
    - ReminderJobs 自动按 label 规则生成
- 返回成功/失败统计
- 月历页面刷新后可看到全部导入事件

---

## **6.5 提醒规则（Reminder Rules）**

**通过条件：**

- 在设置页面可新增/编辑/删除规则
- 对 label＝合同 设置 `[7,3,1]` 时：
    
    新增“合同”事件必须生成 3 个 ReminderJobs
    
- 删除某提醒规则后 → 新增事件使用系统默认规则（1 天前、10:00）

---

## **6.6 Web Push 通知**

**通过条件：**

- 用户首次进入系统 → 提示开启通知
- 允许后能成功保存 PushSubscription
- Scheduler 到点会触发 Web Push
- 浏览器能弹出通知内容
- 点击通知 → 打开事件详情页

**失败条件：**

- endpoint 无效 → subscription 标记失效
- 浏览器禁用通知 → 设置页面提示用户开启

---

## **6.7 搜索与筛选**

**通过条件：**

- 输入关键字可匹配标题与备注
- 按标签筛选能筛除不相关事件
- 搜索与筛选可组合使用

---

## **6.8 系统默认提醒**

**通过条件：**

- 若事件日期为 2025-08-01
- 且 label 没有提醒规则
- 则必须生成一个 ReminderJob：
    
    → **2025-07-31 10:00（北京时间）**