# 提醒任务生成集成

<cite>
**本文档引用的文件**   
- [bulk-create/route.ts](file://app/api/events/bulk-create/route.ts)
- [reminder-jobs.ts](file://lib/reminder-jobs.ts)
- [events/route.ts](file://app/api/events/route.ts)
- [scheduler.ts](file://lib/scheduler.ts)
- [schema.prisma](file://prisma/schema.prisma)
- [route.ts](file://app/api/reminder-rules/route.ts)
- [ReminderRuleDialog.tsx](file://components/ReminderRuleDialog.tsx)
- [page.tsx](file://app/import/page.tsx)
- [sw.js](file://public/sw.js)
- [SCHEDULER_SETUP.md](file://docs/SCHEDULER_SETUP.md)
</cite>

## 目录
1. [简介](#简介)
2. [批量创建事件流程](#批量创建事件流程)
3. [提醒任务生成机制](#提醒任务生成机制)
4. [提醒规则与事件关联](#提醒规则与事件关联)
5. [系统架构与数据流](#系统架构与数据流)
6. [状态流转与执行流程](#状态流转与执行流程)
7. [前端集成与用户交互](#前端集成与用户交互)
8. [调度器与通知系统](#调度器与通知系统)
9. [数据库模型设计](#数据库模型设计)
10. [结论](#结论)

## 简介
本文档详细说明了在批量创建或更新事件后，如何通过调用 `generateReminderJobs` 函数实现提醒任务的自动生成。重点阐述了该集成机制如何确保新导入的事件立即关联其对应的提醒规则，从而实现“导入即提醒”的用户体验。文档涵盖了从事件创建、提醒规则匹配、提醒任务生成到最终推送通知的完整流程。

## 批量创建事件流程
当用户通过CSV文件批量导入事件时，系统通过 `/api/events/bulk-create` 接口处理请求。该接口接收包含多个事件对象的数组，对每个事件进行验证、创建或更新，并在每个事件成功处理后立即调用 `generateReminderJobs` 函数。

```mermaid
flowchart TD
A[开始批量创建] --> B[验证用户身份]
B --> C[解析请求体]
C --> D[验证输入数据]
D --> E[预取用户现有事件]
E --> F[遍历事件数组]
F --> G[规范化日期时间]
G --> H[创建或更新事件]
H --> I[调用generateReminderJobs]
I --> J[记录成功/失败状态]
J --> K{是否还有事件}
K --> |是| F
K --> |否| L[返回结果]
```

**Diagram sources**
- [bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L1-L132)

**Section sources**
- [bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L1-L132)
- [page.tsx](file://app/import/page.tsx#L1-L106)

## 提醒任务生成机制
`generateReminderJobs` 函数是提醒系统的核心，负责为每个事件生成相应的提醒任务。该函数在事件创建或更新后被调用，接收事件的关键参数并根据用户的提醒规则生成提醒任务。

### 函数调用参数
- **id**: 事件的唯一标识符
- **userId**: 事件所属用户的ID
- **date**: 事件日期（YYYY-MM-DD格式）
- **time**: 事件时间（HH:mm格式，可选）
- **label**: 事件标签（用于匹配提醒规则）

### 函数执行流程
```mermaid
flowchart TD
A[开始generateReminderJobs] --> B[删除现有提醒任务]
B --> C{是否存在标签}
C --> |否| D[使用默认规则]
C --> |是| E[查询标签对应的提醒规则]
E --> F{规则是否存在}
F --> |否| D
F --> |是| G[使用自定义规则]
D --> H
G --> H
H[解析事件日期时间] --> I[为每个偏移量生成提醒时间]
I --> J{是否回避周末}
J --> |是| K[调整到周五]
J --> |否| L[保持原时间]
K --> M
L --> M
M[创建提醒任务] --> N[返回生成数量]
```

**Diagram sources**
- [reminder-jobs.ts](file://lib/reminder-jobs.ts#L1-L72)

**Section sources**
- [reminder-jobs.ts](file://lib/reminder-jobs.ts#L1-L72)
- [bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L98-L105)

## 提醒规则与事件关联
系统通过标签（label）将事件与提醒规则关联。当事件带有标签时，系统会查找用户针对该标签设置的提醒规则；若无匹配规则，则使用默认规则。

### 提醒规则模型
```mermaid
classDiagram
class ReminderRule {
+id : string
+userId : string
+label : string
+offsetsInDays : number[]
+defaultTime : string
+avoidWeekends : boolean
+createdAt : DateTime
+updatedAt : DateTime
}
class Event {
+id : string
+userId : string
+title : string
+date : string
+time : string?
+label : string?
+notes : string?
}
class ReminderJob {
+id : string
+userId : string
+eventId : string
+fireTime : DateTime
+sent : boolean
+createdAt : DateTime
}
ReminderRule --> Event : "标签匹配"
Event --> ReminderJob : "包含"
ReminderRule --> ReminderJob : "定义生成规则"
```

**Diagram sources**
- [schema.prisma](file://prisma/schema.prisma#L47-L60)
- [reminder-jobs.ts](file://lib/reminder-jobs.ts#L3-L9)

**Section sources**
- [schema.prisma](file://prisma/schema.prisma#L47-L60)
- [route.ts](file://app/api/reminder-rules/route.ts#L1-L109)
- [ReminderRuleDialog.tsx](file://components/ReminderRuleDialog.tsx#L1-L173)

## 系统架构与数据流
整个提醒系统由多个组件协同工作，形成完整的数据流和控制流。

```mermaid
graph TB
subgraph "前端"
A[导入页面] --> B[事件数据]
B --> C[API调用]
end
subgraph "API层"
C --> D[/api/events/bulk-create\]
D --> E[身份验证]
E --> F[事件处理]
F --> G[调用generateReminderJobs]
end
subgraph "业务逻辑层"
G --> H[reminder-jobs.ts]
H --> I[查询提醒规则]
I --> J[生成提醒任务]
J --> K[存储到数据库]
end
subgraph "数据层"
K --> L[(Prisma数据库)]
end
subgraph "调度系统"
M[定时器] --> N[/api/scheduler/run\]
N --> O[查询待发送提醒]
O --> P[发送推送通知]
P --> Q[Service Worker]
Q --> R[显示通知]
end
L --> O
```

**Diagram sources**
- [bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L1-L132)
- [reminder-jobs.ts](file://lib/reminder-jobs.ts#L1-L109)
- [scheduler.ts](file://lib/scheduler.ts#L1-L86)
- [sw.js](file://public/sw.js#L1-L78)

## 状态流转与执行流程
当事件被创建或更新时，系统经历一系列状态流转以确保提醒任务正确生成和执行。

```mermaid
sequenceDiagram
participant Frontend as 前端
participant API as 批量创建API
participant Reminder as generateReminderJobs
participant DB as 数据库
participant Scheduler as 调度器
Frontend->>API : POST /api/events/bulk-create
API->>API : 验证用户身份
API->>API : 解析并验证事件数据
API->>DB : 查询现有事件
API->>DB : 创建/更新事件
DB-->>API : 返回事件对象
API->>Reminder : 调用generateReminderJobs()
Reminder->>DB : 删除现有提醒任务
Reminder->>DB : 查询提醒规则
alt 规则存在
DB-->>Reminder : 返回规则
else 规则不存在
Reminder->>Reminder : 使用默认规则
end
Reminder->>Reminder : 计算提醒时间
Reminder->>DB : 创建提醒任务
DB-->>Reminder : 返回结果
Reminder-->>API : 返回生成数量
API-->>Frontend : 返回批量创建结果
Scheduler->>DB : 定期查询待发送提醒
alt 存在待发送提醒
DB-->>Scheduler : 返回提醒任务
Scheduler->>Scheduler : 准备通知载荷
Scheduler->>Scheduler : 发送推送通知
Scheduler->>DB : 标记为已发送
end
```

**Diagram sources**
- [bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L98-L105)
- [reminder-jobs.ts](file://lib/reminder-jobs.ts#L15-L72)
- [scheduler.ts](file://lib/scheduler.ts#L8-L86)

## 前端集成与用户交互
用户通过导入页面上传CSV文件，系统处理后自动为每个事件生成提醒任务。

### 导入流程
```mermaid
flowchart TD
A[用户上传CSV文件] --> B[前端解析CSV]
B --> C[验证数据格式]
C --> D[显示预览和错误]
D --> E[用户确认导入]
E --> F[发送到批量创建API]
F --> G[等待响应]
G --> H{导入成功}
H --> |是| I[显示成功统计]
H --> |否| J[显示错误信息]
I --> K[自动跳转日历页]
```

**Section sources**
- [page.tsx](file://app/import/page.tsx#L1-L106)
- [bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L1-L132)

## 调度器与通知系统
系统通过调度器定期检查并发送待处理的提醒通知。

### 调度器工作流程
```mermaid
flowchart TD
A[定时触发] --> B[调用/run API]
B --> C[查询待发送提醒]
C --> D{存在待发送提醒}
D --> |否| E[结束]
D --> |是| F[获取用户订阅]
F --> G{存在订阅}
G --> |否| H[标记为已发送]
G --> |是| I[准备通知载荷]
I --> J[发送推送通知]
J --> K[处理发送结果]
K --> L[标记为已发送]
L --> M{是否还有任务}
M --> |是| C
M --> |否| N[结束]
```

**Diagram sources**
- [scheduler.ts](file://lib/scheduler.ts#L8-L86)
- [run/route.ts](file://app/api/scheduler/run/route.ts#L1-L37)
- [sw.js](file://public/sw.js#L1-L78)

## 数据库模型设计
系统使用Prisma定义了清晰的数据模型，确保事件、提醒规则和提醒任务之间的关系正确。

```mermaid
erDiagram
USER {
string id PK
string email UK
string password
datetime createdAt
}
EVENT {
string id PK
string userId FK
string title
string date
string time
string label
string notes
datetime datetime
datetime createdAt
datetime updatedAt
}
REMINDERRULE {
string id PK
string userId FK
string label UK
int[] offsetsInDays
string defaultTime
boolean avoidWeekends
datetime createdAt
datetime updatedAt
}
REMINDERJOB {
string id PK
string userId FK
string eventId FK
datetime fireTime
boolean sent
datetime createdAt
}
PUSHSUBSCRIPTION {
string id PK
string userId FK
string endpoint
string p256dh
string auth
datetime createdAt
}
USER ||--o{ EVENT : "拥有"
USER ||--o{ REMINDERRULE : "拥有"
USER ||--o{ REMINDERJOB : "拥有"
USER ||--o{ PUSHSUBSCRIPTION : "拥有"
EVENT ||--o{ REMINDERJOB : "生成"
REMINDERRULE ||--o{ EVENT : "应用于"
```

**Diagram sources**
- [schema.prisma](file://prisma/schema.prisma#L16-L86)

## 结论
本集成文档详细说明了批量创建事件后提醒任务生成的完整流程。通过在事件创建或更新后立即调用 `generateReminderJobs` 函数，系统确保了新导入的事件能够立即关联其对应的提醒规则，实现了“导入即提醒”的用户体验。该机制通过清晰的函数调用、合理的数据模型设计和可靠的调度系统，为用户提供及时、准确的提醒服务。