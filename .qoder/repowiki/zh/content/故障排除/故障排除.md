# 故障排除

<cite>
**本文档引用的文件**
- [DIALOG_CLOSE_FIX.md](file://docs/DIALOG_CLOSE_FIX.md)
- [HYDRATION_FIX.md](file://docs/HYDRATION_FIX.md)
- [NOTIFICATION_FIX.md](file://docs/NOTIFICATION_FIX.md)
- [COMPLETION_SUMMARY.md](file://docs/COMPLETION_SUMMARY.md)
- [page.tsx](file://app/calendar/page.tsx)
- [settings/page.tsx](file://app/settings/page.tsx)
- [EventDialog.tsx](file://components/EventDialog.tsx)
- [layout.tsx](file://app/layout.tsx)
- [sw.js](file://public/sw.js)
</cite>

## 目录
1. [模态框快速关闭问题](#模态框快速关闭问题)
2. [服务端与客户端渲染不匹配问题](#服务端与客户端渲染不匹配问题)
3. [推送通知快速消失问题](#推送通知快速消失问题)
4. [已验证的解决方案库](#已验证的解决方案库)

## 模态框快速关闭问题

### 症状描述
用户报告在日历页面点击或长按日期格子时，事件创建模态框（Dialog）出现后立即消失，持续时间不足1秒，无法进行任何操作。

### 根本原因分析
该问题源于触摸事件与点击事件之间的冲突：
- 移动设备上，触摸操作会依次触发 `touchstart`、`touchend` 和模拟的 `click` 事件
- 原始实现中，长按功能使用局部变量存储计时器，在组件重渲染时丢失引用
- `touchend` 触发打开模态框后，延迟的 `click` 事件再次调用打开逻辑，导致状态混乱
- 缺少防止重复触发的机制，造成模态框闪现后关闭

### 修复步骤
1. 使用 `useRef` 替代局部变量存储长按计时器，确保引用在组件生命周期内保持不变
2. 添加 `touchHandled` 标志位，标记是否已处理长按操作
3. 在 `handleTouchStart` 中设置计时器并标记 `touchHandled.current = false`
4. 在 `handleTouchEnd` 中清除计时器，并根据 `touchHandled` 状态调用 `preventDefault()` 阻止后续 `click` 事件
5. 创建 `handleDayClickWrapper` 包装函数，在触发前检查 `touchHandled` 状态
6. 更新事件绑定，使用包装函数处理点击事件

### 预防建议
- 对于需要在组件间持久化的可变值（如定时器、DOM引用），优先使用 `useRef`
- 在处理触摸事件时，始终考虑与点击事件的兼容性
- 使用标志位（flag）防止重复事件触发
- 在 `touchend` 事件中调用 `preventDefault()` 阻止模拟的 `click` 事件
- 遵循 React 事件处理最佳实践，正确传递事件对象

**Section sources**
- [DIALOG_CLOSE_FIX.md](file://docs/DIALOG_CLOSE_FIX.md#L1-L187)
- [page.tsx](file://app/calendar/page.tsx#L143-L184)

## 服务端与客户端渲染不匹配问题

### 症状描述
开发环境中控制台出现 React 水合（hydration）错误，提示服务端渲染的 HTML 与客户端属性不匹配，具体指向 `<html>` 标签上的 `data-jetski-tab-id` 属性。

### 根本原因分析
该问题主要由以下原因导致：
- 浏览器扩展（如 Jetski）在 React 加载前修改了 DOM，向 `<html>` 或 `<body>` 标签添加自定义属性
- 服务端渲染的 HTML 不包含这些扩展添加的属性，而客户端 DOM 包含，导致水合不匹配
- 其他可能原因包括使用 `Date.now()`、`Math.random()` 等非确定性函数，或 `typeof window !== 'undefined'` 的服务端/客户端分支

### 修复步骤
1. 在 `app/layout.tsx` 中为 `<html>` 和 `<body>` 标签添加 `suppressHydrationWarning` 属性
2. 保持该属性仅应用于根元素，避免滥用
3. 验证修复后，确认控制台不再显示水合错误

### 预防建议
- 仅在根元素（`<html>`、`<body>`）上使用 `suppressHydrationWarning`，当确认差异由浏览器扩展引起且不影响功能
- 开发时可临时禁用可能干扰的浏览器扩展，或使用无痕模式测试
- 避免在服务端和客户端产生不一致的渲染内容
- 对于必须在客户端执行的逻辑，考虑使用动态导入 `{ ssr: false }`
- 不要使用 `suppressHydrationWarning` 来掩盖真正的代码问题

**Section sources**
- [HYDRATION_FIX.md](file://docs/HYDRATION_FIX.md#L1-L128)
- [layout.tsx](file://app/layout.tsx#L39-L43)

## 推送通知快速消失问题

### 症状描述
用户在设置页面点击"测试提醒"按钮后，浏览器通知弹窗出现后立即消失，持续时间不足1秒，用户体验极差。

### 根本原因分析
该问题的根本原因是同时使用了两种方式创建通知：
- 直接使用 `new Notification()` 创建通知
- 通过 Service Worker 调用 `registration.showNotification()` 创建通知
- 两个通知使用了相同的 `tag` 属性（`demo-notification`）
- 根据 Web Notifications API 规范，相同 `tag` 的通知会相互替换
- 第一个通知刚显示就被第二个通知替换，造成"闪现后消失"的错觉

### 修复步骤
1. 修改 `triggerTestNotification` 函数，确保只使用一种方式创建通知
2. 优先使用 Service Worker 方式（`registration.showNotification()`），因其支持后台推送
3. 当不支持 Service Worker 时，降级使用直接 API 方式（`new Notification()`）
4. 移除重复的通知创建代码，确保每个触发操作只生成一个通知
5. 添加适当的错误处理和用户反馈

### 预防建议
- 选择单一的通知创建路径，避免混合使用多种方式
- 优先使用 Service Worker 进行通知推送，以支持离线和后台功能
- 为每个通知使用唯一的 `tag` 值，通常包含事件ID和时间戳
- 设置 `requireInteraction: true` 确保重要通知不会自动消失
- 提供完善的错误处理，捕获并显示具体的错误信息
- 在开发和测试阶段，检查通知创建逻辑是否会产生重复通知

**Section sources**
- [NOTIFICATION_FIX.md](file://docs/NOTIFICATION_FIX.md#L1-L266)
- [settings/page.tsx](file://app/settings/page.tsx#L145-L171)

## 已验证的解决方案库

### 搜索与筛选功能
- **问题**：日历页面缺少按标题、备注搜索和按标签筛选的功能
- **解决方案**：实现基于 React 状态的实时过滤系统
- **验证**：用户可输入关键字搜索，选择标签筛选，组合使用多种条件
- **预防**：保持搜索和筛选状态的单一数据源，确保 UI 与状态同步

### 长按/右键新增事件
- **问题**：移动端缺少快速创建事件的交互方式
- **解决方案**：实现长按（500ms）和右键点击创建事件
- **验证**：长按日期格子触发创建，右键点击桌面端日期格子触发创建
- **预防**：使用 `useRef` 管理计时器，防止事件冲突

### 拖拽调整日期
- **问题**：无法通过拖拽方式调整事件日期
- **解决方案**：使用 HTML5 Drag and Drop API 实现拖拽功能
- **验证**：用户可拖拽事件卡片到新日期，目标日期高亮显示
- **预防**：添加放置前确认对话框，防止误操作

### 提醒避开周末
- **问题**：提醒可能在周末发送，影响用户体验
- **解决方案**：在提醒规则中添加"避开周末"选项
- **验证**：当提醒时间落在周六或周日时，自动提前至周五
- **预防**：在 `lib/reminder-jobs.ts` 中实现日期调整逻辑

**Section sources**
- [COMPLETION_SUMMARY.md](file://docs/COMPLETION_SUMMARY.md#L1-L240)
- [README.md](file://README.md#L1-L152)