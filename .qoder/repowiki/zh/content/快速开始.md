# 快速开始

<cite>
**本文档中引用的文件**   
- [README.md](file://README.md)
- [package.json](file://package.json)
- [prisma/schema.prisma](file://prisma/schema.prisma)
- [lib/prisma.ts](file://lib/prisma.ts)
- [lib/auth.ts](file://lib/auth.ts)
- [lib/web-push.ts](file://lib/web-push.ts)
- [prisma.config.ts](file://prisma.config.ts)
- [app/api/auth/login/route.ts](file://app/api/auth/login/route.ts)
- [app/login/page.tsx](file://app/login/page.tsx)
- [app/calendar/page.tsx](file://app/calendar/page.tsx)
</cite>

## 目录
1. [简介](#简介)
2. [环境准备](#环境准备)
3. [安装依赖](#安装依赖)
4. [配置环境变量](#配置环境变量)
5. [初始化数据库](#初始化数据库)
6. [启动开发服务器](#启动开发服务器)
7. [访问应用](#访问应用)
8. [常见问题与解决方案](#常见问题与解决方案)
9. [总结](#总结)

## 简介

本指南旨在帮助新手开发者在本地快速搭建并运行 `todo-csv-import` 项目。通过本指南，您将在10分钟内完成环境配置，成功启动应用并访问其界面。该项目是一个全栈日历提醒应用，支持用户认证、事件管理、CSV批量导入、Web推送通知等功能。

**Section sources**
- [README.md](file://README.md#L1-L152)

## 环境准备

在开始之前，请确保您的开发环境已安装以下工具：

- **Node.js** (建议版本 18.x 或更高)
- **pnpm** (包管理工具，可通过 `npm install -g pnpm` 安装)
- **PostgreSQL** 数据库（本地或远程均可）
- 文本编辑器（如 VS Code）

项目技术栈：
- 前端：Next.js 14 (App Router), TypeScript, TailwindCSS, Shadcn UI
- 后端：Next.js API Routes, Prisma ORM
- 数据库：PostgreSQL
- 认证：JWT + HTTP-only Cookie
- 推送：Web Push (VAPID)

**Section sources**
- [README.md](file://README.md#L69-L86)

## 安装依赖

进入项目根目录后，使用 pnpm 安装所有依赖包：

```bash
pnpm install
```

该命令将根据 `package.json` 文件安装项目所需的所有依赖项。

**Section sources**
- [package.json](file://package.json#L1-L62)
- [README.md](file://README.md#L95-L96)

## 配置环境变量

项目需要配置多个环境变量，首先复制示例文件：

```bash
cp .env.example .env
```

然后编辑 `.env` 文件，设置以下关键变量：

### 数据库连接
```env
DATABASE_URL=postgresql://user:password@localhost:5432/todo_db?schema=public
```

请根据您的 PostgreSQL 实例信息修改用户名、密码、主机地址和数据库名称。

### JWT 密钥
```env
JWT_SECRET=your_jwt_secret_key_here
```

用于生成和验证 JWT Token，建议使用强随机字符串。

### VAPID 密钥（Web Push）
```env
NEXT_PUBLIC_VAPID_PUBLIC_KEY=your_vapid_public_key
VAPID_PRIVATE_KEY=your_vapid_private_key
VAPID_SUBJECT=mailto:admin@example.com
```

VAPID 密钥用于浏览器推送通知。可通过以下命令生成：
```bash
npx web-push generate-vapid-keys
```

**Section sources**
- [lib/prisma.ts](file://lib/prisma.ts#L9-L11)
- [lib/auth.ts](file://lib/auth.ts#L4)
- [lib/web-push.ts](file://lib/web-push.ts#L5-L7)
- [README.md](file://README.md#L98-L100)

## 初始化数据库

使用 Prisma 迁移工具初始化数据库结构：

```bash
npx prisma migrate dev --name init
```

该命令将：
1. 读取 `prisma/schema.prisma` 中的模型定义
2. 在数据库中创建对应的表结构
3. 生成 Prisma Client

数据库模型包括：
- **User**: 用户信息（邮箱、密码等）
- **Event**: 日程事件（标题、日期、标签等）
- **ReminderRule**: 提醒规则（按标签配置提前天数）
- **ReminderJob**: 待发送的提醒任务
- **PushSubscription**: 用户的推送订阅信息

```mermaid
erDiagram
User {
string id PK
string email UK
string password
datetime createdAt
}
Event {
string id PK
string userId FK
string title
string date
string time
string label
text notes
datetime datetime
datetime createdAt
datetime updatedAt
}
ReminderRule {
string id PK
string userId FK
string label
int[] offsetsInDays
string defaultTime
boolean avoidWeekends
datetime createdAt
datetime updatedAt
}
ReminderJob {
string id PK
string userId FK
string eventId FK
datetime fireTime
boolean sent
datetime createdAt
}
PushSubscription {
string id PK
string userId FK
string endpoint
string p256dh
string auth
datetime createdAt
}
User ||--o{ Event : "拥有"
User ||--o{ ReminderRule : "拥有"
User ||--o{ ReminderJob : "拥有"
User ||--o{ PushSubscription : "拥有"
Event ||--o{ ReminderJob : "生成"
```

**Diagram sources**
- [prisma/schema.prisma](file://prisma/schema.prisma#L16-L86)
- [prisma.config.ts](file://prisma.config.ts#L12)

**Section sources**
- [prisma/schema.prisma](file://prisma/schema.prisma#L1-L86)
- [prisma.config.ts](file://prisma.config.ts#L5-L14)

## 启动开发服务器

完成上述步骤后，启动开发服务器：

```bash
pnpm dev
```

该命令将启动 Next.js 开发服务器，默认监听 `http://localhost:3000`。

**Section sources**
- [package.json](file://package.json#L6)
- [README.md](file://README.md#L104-L105)

## 访问应用

服务器启动后，打开浏览器访问以下路径：

- **登录页面**: `http://localhost:3000/login`
- **注册页面**: `http://localhost:3000/register`
- **日历主页**: `http://localhost:3000/calendar`
- **CSV导入**: `http://localhost:3000/import`
- **设置页面**: `http://localhost:3000/settings`

首次使用请先访问 `/register` 注册账户，然后使用 `/login` 登录。登录成功后将自动跳转至 `/calendar` 页面。

```mermaid
flowchart TD
A[启动服务器] --> B{访问 /login}
B --> C[输入邮箱密码]
C --> D[调用 /api/auth/login]
D --> E{验证成功?}
E --> |是| F[设置 HTTP-only Cookie]
F --> G[重定向到 /calendar]
G --> H[加载月度日程]
H --> I[显示日历界面]
E --> |否| J[返回错误信息]
```

**Diagram sources**
- [app/api/auth/login/route.ts](file://app/api/auth/login/route.ts#L11-L57)
- [app/login/page.tsx](file://app/login/page.tsx#L1-L109)
- [middleware.ts](file://middleware.ts#L5-L50)

**Section sources**
- [app/login/page.tsx](file://app/login/page.tsx#L1-L109)
- [app/calendar/page.tsx](file://app/calendar/page.tsx#L1-L468)

## 常见问题与解决方案

### 数据库连接失败
**问题**: `npx prisma migrate dev` 报错连接拒绝  
**解决方案**:  
1. 确认 PostgreSQL 服务已启动
2. 检查 `.env` 中的 `DATABASE_URL` 是否正确
3. 确认数据库用户有创建数据库的权限

### 环境变量缺失
**问题**: 应用启动后登录或推送功能异常  
**解决方案**:  
1. 确保 `.env` 文件存在且已正确配置
2. 检查 `JWT_SECRET` 和 `VAPID` 密钥是否设置
3. 重启开发服务器使环境变量生效

### 页面空白或 hydration 错误
**问题**: 浏览器显示空白页面  
**解决方案**:  
1. 检查控制台是否有 JavaScript 错误
2. 确认所有依赖已正确安装（可尝试 `pnpm install --force`）
3. 清除 Next.js 缓存（删除 `.next` 目录）

### Web Push 不工作
**问题**: 无法订阅推送通知  
**解决方案**:  
1. 确认 VAPID 密钥已正确配置
2. 必须使用 HTTPS 或 `localhost`（开发环境）
3. 检查浏览器是否阻止了通知权限

**Section sources**
- [lib/prisma.ts](file://lib/prisma.ts#L9-L11)
- [lib/auth.ts](file://lib/auth.ts#L4)
- [lib/web-push.ts](file://lib/web-push.ts#L5-L7)
- [middleware.ts](file://middleware.ts#L6-L7)

## 总结

通过以上步骤，您已成功在本地搭建并运行了 `todo-csv-import` 项目。本指南涵盖了从环境准备到问题排查的完整流程，确保新手开发者能够快速上手。项目具备完善的用户认证、日程管理、CSV导入和推送通知功能，可作为企业级日历应用的基础模板。

**Section sources**
- [README.md](file://README.md#L1-L152)
- [package.json](file://package.json#L1-L62)