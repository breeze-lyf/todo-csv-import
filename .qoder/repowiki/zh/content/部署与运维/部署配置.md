# 部署配置

<cite>
**本文档引用的文件**  
- [vercel.json](file://vercel.json)
- [next.config.ts](file://next.config.ts)
- [lib/scheduler.ts](file://lib/scheduler.ts)
- [app/api/scheduler/run/route.ts](file://app/api/scheduler/run/route.ts)
- [lib/prisma.ts](file://lib/prisma.ts)
- [prisma.config.ts](file://prisma.config.ts)
- [lib/web-push.ts](file://lib/web-push.ts)
- [lib/auth.ts](file://lib/auth.ts)
- [docs/SCHEDULER_SETUP.md](file://docs/SCHEDULER_SETUP.md)
</cite>

## 目录
1. [简介](#简介)
2. [Vercel Cron 作业配置](#vercel-cron-作业配置)
3. [环境变量配置要求](#环境变量配置要求)
4. [Next.js 构建优化配置](#nextjs-构建优化配置)
5. [不同部署平台的配置差异与限制](#不同部署平台的配置差异与限制)
6. [安全建议](#安全建议)

## 简介
本指南详细说明如何为本项目在 Vercel 平台上配置定时任务（Cron Job），以确保提醒调度器能够定期运行。系统通过 `/api/scheduler/run` 接口触发定时任务，用于发送即将到期的事件提醒。文档涵盖 `vercel.json` 中的 cron 配置、必要的环境变量设置、Next.js 构建优化选项，以及在不同部署方案下的配置差异。

## Vercel Cron 作业配置

`vercel.json` 文件用于定义在 Vercel 平台上运行的定时任务。当前配置如下：

```json
{
    "crons": [
        {
            "path": "/api/scheduler/run",
            "schedule": "* * * * *"
        }
    ]
}
```

### crons 数组字段说明

- **path**: 指定要触发的 API 路径。此处为 `/api/scheduler/run`，对应 `app/api/scheduler/run/route.ts` 文件中的路由处理程序。
- **schedule**: 使用标准的 crontab 表达式定义执行频率。`* * * * *` 表示每分钟执行一次。

该配置确保调度器每分钟自动调用一次，检查是否有待发送的提醒任务，并通过 Web Push 协议向用户推送通知。

```mermaid
sequenceDiagram
participant Vercel as Vercel Cron
participant API as /api/scheduler/run
participant Scheduler as runReminderScheduler
participant DB as 数据库
participant Push as Web Push 服务
Vercel->>API : POST 请求触发
API->>Scheduler : 调用 runReminderScheduler()
Scheduler->>DB : 查询 pending 的提醒任务
DB-->>Scheduler : 返回待处理任务列表
loop 每个任务
Scheduler->>Push : 发送推送通知
Push-->>Scheduler : 返回发送结果
Scheduler->>DB : 标记任务为已发送
end
Scheduler-->>API : 返回处理结果
API-->>Vercel : 返回成功响应
```

**Diagram sources**
- [vercel.json](file://vercel.json#L2-L7)
- [app/api/scheduler/run/route.ts](file://app/api/scheduler/run/route.ts#L8-L37)
- [lib/scheduler.ts](file://lib/scheduler.ts#L8-L86)

**Section sources**
- [vercel.json](file://vercel.json#L1-L8)
- [app/api/scheduler/run/route.ts](file://app/api/scheduler/run/route.ts#L1-L37)

## 环境变量配置要求

部署时必须在 Vercel 或其他平台的环境变量中正确配置以下参数：

### 数据库连接字符串
- **DATABASE_URL**: PostgreSQL 数据库连接字符串，格式为 `postgresql://user:password@host:port/dbname?sslmode=require`。该变量被 `prisma.config.ts` 和 `lib/prisma.ts` 用于初始化 Prisma 客户端。

**Section sources**
- [prisma.config.ts](file://prisma.config.ts#L12)
- [lib/prisma.ts](file://lib/prisma.ts#L9)

### JWT 密钥
- **JWT_SECRET**: 用于签名和验证用户身份令牌（Token）的密钥。必须为足够强度的随机字符串，在生产环境中不可使用默认值。该密钥由 `lib/auth.ts` 使用。

**Section sources**
- [lib/auth.ts](file://lib/auth.ts#L4)

### VAPID 密钥（Web Push）
- **NEXT_PUBLIC_VAPID_PUBLIC_KEY**: 前端使用的 VAPID 公钥，用于订阅浏览器推送服务。
- **VAPID_PRIVATE_KEY**: 后端使用的 VAPID 私钥，用于加密推送消息。
- **VAPID_SUBJECT**: VAPID 主题，通常为 `mailto:admin@example.com` 格式的邮箱地址。

这些密钥由 `lib/web-push.ts` 初始化 Web Push 服务，并通过 `/api/push/vapid-public-key` 提供给前端。

**Section sources**
- [lib/web-push.ts](file://lib/web-push.ts#L5-L7)

## Next.js 构建优化配置

`next.config.ts` 文件包含 Next.js 应用的构建和运行时配置。虽然当前文件为空，但可根据需要添加以下优化选项：

```ts
const nextConfig: NextConfig = {
  experimental: {
    serverActions: true,
  },
  logging: {
    fetches: {
      fullUrl: true,
    },
  },
}
```

建议启用 `serverActions` 实验性功能以支持服务端操作，并开启日志记录以便调试。此外，可结合 `output: 'standalone'` 生成更轻量的部署包。

**Section sources**
- [next.config.ts](file://next.config.ts#L1-L8)

## 不同部署平台的配置差异与限制

### Vercel Pro 及以上计划
- 支持内置 Cron 功能，可通过 `vercel.json` 直接配置。
- 推荐用于生产环境，稳定性高，集成度好。
- 免费 Hobby 计划不支持 Cron，仅 Pro 及以上版本可用。

### 免费替代方案

#### 使用 cron-job.org
- 创建免费账户后添加任务：
  - URL: `https://your-domain.vercel.app/api/scheduler/run`
  - 方法: POST
  - 调度: `* * * * *`（每分钟）

#### 使用 EasyCron
- 类似配置，提供免费额度，适合低频任务。

#### 使用 GitHub Actions
适用于开源项目，创建 `.github/workflows/scheduler.yml`：

```yaml
name: Run Scheduler
on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:
jobs:
  run-scheduler:
    runs-on: ubuntu-latest
    steps:
      - name: Call Scheduler API
        run: |
          curl -X POST https://your-domain.vercel.app/api/scheduler/run
```

此方式利用 GitHub 的免费计划实现定时调用。

**Section sources**
- [docs/SCHEDULER_SETUP.md](file://docs/SCHEDULER_SETUP.md#L20-L58)

## 安全建议

为防止未授权访问调度接口，建议在 `POST` 处理函数中添加身份验证：

```ts
export async function POST(req: NextRequest) {
  const authHeader = req.headers.get('authorization')
  const expectedToken = process.env.SCHEDULER_SECRET
  
  if (authHeader !== `Bearer ${expectedToken}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  
  // 继续执行调度逻辑
}
```

同时在环境变量中设置 `SCHEDULER_SECRET`，并在外部调用时携带 `Authorization: Bearer <token>` 头部。

**Section sources**
- [docs/SCHEDULER_SETUP.md](file://docs/SCHEDULER_SETUP.md#L68-L87)