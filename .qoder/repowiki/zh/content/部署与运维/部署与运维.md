# 部署与运维

<cite>
**本文档引用文件**  
- [vercel.json](file://vercel.json)
- [app/api/scheduler/run/route.ts](file://app/api/scheduler/run/route.ts)
- [lib/scheduler.ts](file://lib/scheduler.ts)
- [lib/prisma.ts](file://lib/prisma.ts)
- [prisma/schema.prisma](file://prisma/schema.prisma)
- [lib/web-push.ts](file://lib/web-push.ts)
- [docs/SCHEDULER_SETUP.md](file://docs/SCHEDULER_SETUP.md)
- [README.md](file://README.md)
</cite>

## 目录

1. [简介](#简介)
2. [Vercel平台部署配置](#vercel平台部署配置)
3. [调度器运维方案](#调度器运维方案)
4. [数据库备份与迁移策略](#数据库备份与迁移策略)
5. [监控建议](#监控建议)
6. [扩展性考虑](#扩展性考虑)
7. [附录](#附录)

## 简介

本指南旨在为 `todo-csv-import` 项目提供完整的生产环境部署与运维方案。内容涵盖 Vercel 平台的部署配置、调度器的外部调用机制、数据库管理策略、系统监控建议以及应对高负载的扩展性规划。通过遵循本文档，运维人员可确保系统稳定运行并具备良好的可维护性。

## Vercel平台部署配置

### 部署配置文件（vercel.json）

项目根目录下的 `vercel.json` 文件已预配置定时任务（Cron Job），用于定期触发提醒调度器。其核心配置如下：

```json
{
  "crons": [
    {
      "path": "/api/scheduler/run",
      "schedule": "* * * * *"
    }
  ]
}
```

该配置表示每分钟自动调用一次 `/api/scheduler/run` 接口，执行提醒任务的扫描与推送。

**注意事项**：
- Vercel Cron 功能仅在 Pro 及以上付费计划中可用。
- 若使用免费计划，需采用外部 Cron 服务替代（详见下文）。

### 环境变量设置要求

部署前必须在 Vercel 项目环境中配置以下关键环境变量：

| 环境变量 | 说明 |
|--------|------|
| `DATABASE_URL` | PostgreSQL 数据库连接字符串，格式为 `postgresql://user:password@host:port/dbname` |
| `NEXT_PUBLIC_VAPID_PUBLIC_KEY` | Web Push 通知使用的 VAPID 公钥 |
| `VAPID_PRIVATE_KEY` | Web Push 通知使用的 VAPID 私钥 |
| `VAPID_SUBJECT` | VAPID 主体信息，通常为 `mailto:admin@example.com` |
| `SCHEDULER_SECRET` | 调度器接口认证密钥，用于防止未授权访问 |

**生成 VAPID 密钥**：
可通过以下命令生成密钥对：
```bash
npx web-push generate-vapid-keys
```

**安全建议**：
- `VAPID_PRIVATE_KEY` 和 `SCHEDULER_SECRET` 必须保密，不得提交至版本控制系统。
- 建议定期轮换 VAPID 密钥以增强安全性。

**Section sources**
- [vercel.json](file://vercel.json#L1-L8)
- [lib/web-push.ts](file://lib/web-push.ts#L5-L7)
- [docs/SCHEDULER_SETUP.md](file://docs/SCHEDULER_SETUP.md#L68-L87)

## 调度器运维方案

### 外部Cron服务调用方案

当无法使用 Vercel 内置 Cron 时，推荐使用外部 Cron 服务定期调用 `/api/scheduler/run` 端点。以下是几种可行方案：

#### 使用 cron-job.org（免费）

1. 访问 https://cron-job.org 并注册账户
2. 创建新任务：
   - URL: `https://your-domain.vercel.app/api/scheduler/run`
   - 请求方法: POST
   - 调度表达式: `* * * * *`（每分钟执行）
3. 启用任务并验证执行日志

#### 使用 EasyCron（免费套餐可用）

1. 访问 https://www.easycron.com 并注册
2. 添加新任务：
   - URL: `https://your-domain.vercel.app/api/scheduler/run`
   - Cron 表达式: `* * * * *`
3. 配置通知方式以接收执行状态

#### 使用 GitHub Actions（适用于公开仓库）

在 `.github/workflows/scheduler.yml` 中定义工作流：

```yaml
name: Run Scheduler

on:
  schedule:
    - cron: '* * * * *'  # 每分钟
  workflow_dispatch:     # 支持手动触发

jobs:
  run-scheduler:
    runs-on: ubuntu-latest
    steps:
      - name: Call Scheduler API
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SCHEDULER_TOKEN }}" \
            https://your-domain.vercel.app/api/scheduler/run
```

**认证增强**：
为防止未授权调用，建议在 `app/api/scheduler/run/route.ts` 中添加令牌验证逻辑：

```typescript
const authHeader = req.headers.get('authorization');
const expectedToken = process.env.SCHEDULER_SECRET;

if (authHeader !== `Bearer ${expectedToken}`) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}
```

**Section sources**
- [app/api/scheduler/run/route.ts](file://app/api/scheduler/run/route.ts#L8-L37)
- [docs/SCHEDULER_SETUP.md](file://docs/SCHEDULER_SETUP.md#L20-L87)

## 数据库备份与迁移策略

### 数据库架构

系统使用 PostgreSQL 作为持久化存储，通过 Prisma ORM 管理数据模型。核心表结构包括：

- `User`: 用户信息
- `Event`: 事件记录
- `ReminderRule`: 提醒规则（按标签配置）
- `ReminderJob`: 待处理的提醒任务
- `PushSubscription`: 用户的推送订阅信息

**索引优化**：
- `ReminderJob` 表在 `(userId, sent, fireTime)` 上建立了复合索引，确保调度器能高效查询待处理任务。
- `Event` 表在 `(userId, date)` 上建立索引，优化日历视图查询性能。

### 备份策略

1. **自动备份**：启用数据库提供商的自动备份功能（如 Vercel Postgres 的每日快照）。
2. **手动导出**：定期执行逻辑备份：
   ```bash
   pg_dump -h host -U user -d dbname -f backup.sql
   ```
3. **备份验证**：定期恢复测试备份文件以确保完整性。

### 迁移策略

使用 Prisma Migrate 进行数据库模式变更管理：

```bash
# 生成迁移文件
npx prisma migrate dev --name "add_field_to_event"

# 应用迁移到生产环境
npx prisma migrate deploy
```

**最佳实践**：
- 所有模式变更必须通过迁移脚本执行，禁止直接修改数据库。
- 生产环境迁移前需在预发布环境充分测试。
- 重大变更前需备份数据库。

**Section sources**
- [lib/prisma.ts](file://lib/prisma.ts#L9-L11)
- [prisma/schema.prisma](file://prisma/schema.prisma#L1-L86)
- [README.md](file://README.md#L83)

## 监控建议

### API调用日志记录

系统已在关键路径添加结构化日志输出：

- 调度器执行日志（`[Scheduler]` 前缀）
- 推送通知成功/失败记录
- 数据库操作异常捕获

**日志示例**：
```
[Scheduler] Running reminder scheduler...
[Scheduler] Found 5 pending jobs
[Scheduler] Sent notification for job xxx to 2 subscriptions
```

建议将日志集成至集中式日志系统（如 Datadog、Sentry 或 Vercel Analytics）。

### 错误追踪

1. **异常捕获**：所有 API 路由均包含 try-catch 块，确保错误被捕获并返回适当状态码。
2. **错误上报**：集成 Sentry 或类似工具，实时监控生产环境异常。
3. **订阅清理**：当推送返回 410（Gone）状态码时，自动删除无效订阅，防止重复失败。

### 性能指标收集

建议监控以下关键指标：

| 指标 | 说明 | 告警阈值 |
|------|------|----------|
| API 响应时间 | `/api/scheduler/run` 执行耗时 | > 5s |
| 待处理任务数 | `ReminderJob` 中 `sent=false` 的记录数 | > 100 |
| 推送失败率 | 单次调度中推送失败比例 | > 10% |
| 数据库连接数 | 当前活跃连接数 | > 80% 最大连接 |

可通过定期调用健康检查接口获取状态信息：

```bash
curl https://your-domain.vercel.app/api/scheduler/run
```

**Section sources**
- [lib/scheduler.ts](file://lib/scheduler.ts#L9-L85)
- [app/api/scheduler/run/route.ts](file://app/api/scheduler/run/route.ts#L19-L25)
- [lib/reminder-jobs.ts](file://lib/reminder-jobs.ts#L77-L97)

## 扩展性考虑

### 资源规划

当系统面临大量推送订阅时，需考虑以下扩展方案：

#### 计算资源

- **Vercel Serverless Functions**：默认有 10 秒超时限制。若调度器处理时间过长，建议：
  - 优化查询性能（确保索引有效）
  - 分批处理任务（每次最多处理 50 个待办）
  - 升级至更高配额计划以获得更长执行时间

#### 推送服务优化

- **并发控制**：在 `runReminderScheduler` 中限制并发推送数量，避免资源耗尽：
  ```typescript
  // 使用 p-limit 等工具控制并发
  const limit = pLimit(5); // 同时最多5个并发
  const promises = pendingJobs.map(job => limit(() => processJob(job)));
  ```

- **失败重试机制**：对临时性错误（如网络超时）实现指数退避重试。

#### 数据库优化

- **读写分离**：对于高并发场景，可配置读写分离以减轻主库压力。
- **连接池管理**：合理配置 PostgreSQL 连接池大小，避免连接耗尽。

#### 水平扩展

- **微服务拆分**：将调度器独立为专用服务，与主应用解耦。
- **消息队列**：引入 Redis 或 RabbitMQ 作为任务队列，实现异步处理与削峰填谷。

**性能瓶颈识别**：
- 监控 `ReminderJob` 表大小，若增长过快需优化提醒规则。
- 定期分析慢查询日志，优化数据库访问路径。

**Section sources**
- [lib/scheduler.ts](file://lib/scheduler.ts#L17-L77)
- [lib/reminder-jobs.ts](file://lib/reminder-jobs.ts#L77-L97)

## 附录

### 参考文档

- [SCHEDULER_SETUP.md](file://docs/SCHEDULER_SETUP.md): 调度器生产环境配置指南
- [PRD.md](file://docs/PRD.md): 产品需求文档
- [NEW_FEATURES_GUIDE.md](file://docs/NEW_FEATURES_GUIDE.md): 新功能使用指南

### 常见问题

**Q: 调度器未按时执行怎么办？**  
A: 检查 Vercel Cron 配置、环境变量 `SCHEDULER_SECRET` 是否正确，并查看函数执行日志。

**Q: 推送通知无法送达？**  
A: 确认 VAPID 密钥配置正确，用户已授权通知权限，且 Service Worker 正常注册。

**Q: 如何手动触发调度器？**  
A: 发送 POST 请求至 `/api/scheduler/run`，建议携带认证头：
```bash
curl -X POST -H "Authorization: Bearer your-secret-token" https://your-domain.vercel.app/api/scheduler/run
```