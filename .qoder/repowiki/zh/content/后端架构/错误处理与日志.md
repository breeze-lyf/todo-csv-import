# 错误处理与日志

<cite>
**本文档引用的文件**  
- [middleware.ts](file://middleware.ts)
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts)
- [lib/scheduler.ts](file://lib/scheduler.ts)
- [app/api/scheduler/run/route.ts](file://app/api/scheduler/run/route.ts)
- [lib/web-push.ts](file://lib/web-push.ts)
- [lib/reminder-jobs.ts](file://lib/reminder-jobs.ts)
- [lib/auth.ts](file://lib/auth.ts)
- [app/api/auth/login/route.ts](file://app/api/auth/login/route.ts)
- [app/api/auth/register/route.ts](file://app/api/auth/register/route.ts)
- [app/api/events/route.ts](file://app/api/events/route.ts)
- [hooks/use-toast.ts](file://hooks/use-toast.ts)
</cite>

## 目录
1. [简介](#简介)
2. [现有错误处理模式分析](#现有错误处理模式分析)
3. [统一错误响应格式建议](#统一错误响应格式建议)
4. [全局错误处理中间件设计](#全局错误处理中间件设计)
5. [日志记录最佳实践](#日志记录最佳实践)
6. [客户端与服务器错误区分](#客户端与服务器错误区分)
7. [错误监控与追踪建议](#错误监控与追踪建议)
8. [结论](#结论)

## 简介
本文件旨在分析当前代码库中的错误处理模式，并制定统一的错误处理策略。通过分析现有实现，我们将建立标准化的错误响应格式，优化日志记录实践，并建议集成错误监控服务以提高系统的可维护性和可观测性。

## 现有错误处理模式分析

### 认证相关错误处理
在 `middleware.ts` 文件中，系统实现了基于 JWT 的认证中间件。当 JWT 验证失败时，系统会返回 401 未授权状态码，并在重定向到登录页面的同时清理客户端的 token cookie。这种设计确保了无效认证状态能够被及时清除，防止用户陷入认证循环。

在 `app/api/auth/login/route.ts` 中，登录接口对输入验证失败返回 400 错误，对无效凭据返回 401 错误，实现了清晰的错误分类。

**Section sources**
- [middleware.ts](file://middleware.ts#L1-L50)
- [app/api/auth/login/route.ts](file://app/api/auth/login/route.ts#L1-L57)

### 批量创建错误处理
`app/api/events/bulk-create/route.ts` 文件展示了复杂的错误处理模式。该接口使用 Zod 进行输入验证，对无效输入返回 400 错误。在处理 CSV 数据导入时，系统采用批量处理策略：即使部分数据处理失败，也会继续处理其余数据，并在响应中包含详细的错误信息（包括失败索引和具体错误消息）。

```mermaid
flowchart TD
Start([开始处理批量创建]) --> ValidateToken["验证用户令牌"]
ValidateToken --> TokenValid{"令牌有效?"}
TokenValid --> |否| Return401["返回401未授权"]
TokenValid --> |是| ParseJSON["解析JSON请求体"]
ParseJSON --> ValidateInput["使用Zod验证输入"]
ValidateInput --> InputValid{"输入有效?"}
InputValid --> |否| Return400["返回400无效输入"]
InputValid --> |是| ProcessEvents["逐个处理事件"]
ProcessEvents --> ProcessEvent["处理单个事件"]
ProcessEvent --> DBOperation["执行数据库操作"]
DBOperation --> Success{"操作成功?"}
Success --> |是| UpdateCount["更新成功计数"]
Success --> |否| CaptureError["捕获错误并记录"]
UpdateCount --> NextEvent["处理下一个事件"]
CaptureError --> NextEvent
NextEvent --> MoreEvents{"还有更多事件?"}
MoreEvents --> |是| ProcessEvent
MoreEvents --> |否| ReturnResult["返回结果统计"]
ReturnResult --> End([结束])
```

**Diagram sources**
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L1-L133)

**Section sources**
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L1-L133)

### 调度系统错误处理
`lib/scheduler.ts` 文件中的调度器实现了健壮的错误处理机制。系统在处理推送通知时，对每个订阅单独捕获异常，确保单个订阅的失败不会影响其他订阅的处理。当收到 410 Gone 响应时，系统会自动清理无效的推送订阅，维护了订阅列表的健康状态。

```mermaid
sequenceDiagram
participant Scheduler as "调度器"
participant DB as "数据库"
participant PushService as "推送服务"
Scheduler->>DB : 获取待处理的提醒任务
DB-->>Scheduler : 返回任务列表
loop 每个待处理任务
Scheduler->>DB : 获取用户推送订阅
DB-->>Scheduler : 返回订阅列表
loop 每个订阅
Scheduler->>PushService : 发送推送通知
PushService-->>Scheduler : 返回结果
alt 发送失败
Scheduler->>Scheduler : 记录错误日志
Scheduler->>Scheduler : 检查是否为410错误
alt 是410错误
Scheduler->>DB : 删除无效订阅
end
end
end
Scheduler->>DB : 标记任务为已发送
end
Scheduler->>Scheduler : 记录调度完成日志
```

**Diagram sources**
- [lib/scheduler.ts](file://lib/scheduler.ts#L1-L86)
- [lib/web-push.ts](file://lib/web-push.ts#L1-L54)

**Section sources**
- [lib/scheduler.ts](file://lib/scheduler.ts#L1-L86)
- [lib/web-push.ts](file://lib/web-push.ts#L1-L54)

## 统一错误响应格式建议

### 当前问题分析
目前系统中的错误响应格式不一致：
- `middleware.ts` 返回 `{ error: 'Unauthorized' }`
- `bulk-create/route.ts` 返回 `{ error: 'Invalid input', details: result.error }`
- `register/route.ts` 返回 `{ error: "Internal Server Error", detail: String(error?.message ?? error) }`

### 建议的统一格式
建议建立全局错误响应函数，标准化错误输出格式：

```typescript
interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: any;
    timestamp: string;
    requestId?: string;
  };
}
```

**Section sources**
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L34-L36)
- [app/api/auth/register/route.ts](file://app/api/auth/register/route.ts#L47-L49)

## 全局错误处理中间件设计

### 中间件实现建议
建议创建全局错误处理中间件，集中处理所有路由的异常：

```mermaid
graph TD
A[API请求] --> B{全局错误处理中间件}
B --> C[执行业务逻辑]
C --> D{发生异常?}
D --> |是| E[捕获异常并标准化]
E --> F[记录结构化日志]
F --> G[返回统一错误响应]
D --> |否| H[返回正常响应]
G --> I[客户端]
H --> I
```

**Diagram sources**
- [middleware.ts](file://middleware.ts#L1-L50)
- [app/api/scheduler/run/route.ts](file://app/api/scheduler/run/route.ts#L1-L37)

## 日志记录最佳实践

### 当前日志实践分析
系统已在关键路径添加了日志记录：
- 调度器在开始、结束和关键步骤记录日志
- 各 API 路由在捕获异常时使用 `console.error` 记录错误
- 推送服务记录发送失败的详细信息

### 结构化日志建议
建议将日志升级为结构化格式，便于分析和监控：

```mermaid
flowchart TD
A[日志事件] --> B{日志级别}
B --> |error| C["console.error({ level: 'error', component: 'scheduler', message: 'Error processing job', jobId: '...', error: error, timestamp: '...' })"]
B --> |warn| D["console.warn({ level: 'warn', component: 'push', message: 'Invalid subscription', subscriptionId: '...', statusCode: 410, timestamp: '...' })"]
B --> |info| E["console.info({ level: 'info', component: 'auth', message: 'User logged in', userId: '...', ip: '...', timestamp: '...' })"]
B --> |debug| F["console.debug({ level: 'debug', component: 'events', message: 'Processing event', eventId: '...', data: event, timestamp: '...' })"]
```

**Diagram sources**
- [lib/scheduler.ts](file://lib/scheduler.ts#L9-L85)
- [app/api/auth/login/route.ts](file://app/api/auth/login/route.ts#L52)
- [lib/web-push.ts](file://lib/web-push.ts#L43)

**Section sources**
- [lib/scheduler.ts](file://lib/scheduler.ts#L9-L85)
- [app/api/auth/login/route.ts](file://app/api/auth/login/route.ts#L52)
- [lib/web-push.ts](file://lib/web-push.ts#L43)

## 客户端与服务器错误区分

### 错误分类标准
系统应明确区分客户端错误（4xx）和服务器错误（5xx）：

```mermaid
classDiagram
class ClientError {
+statusCode : 4xx
+原因 : 用户输入错误
+示例 : 400 无效输入
+示例 : 401 未授权
+示例 : 404 未找到
+处理 : 客户端应修正请求
}
class ServerError {
+statusCode : 5xx
+原因 : 服务器内部问题
+示例 : 500 内部服务器错误
+示例 : 502 网关错误
+示例 : 503 服务不可用
+处理 : 服务端需修复问题
}
ClientError <|-- ValidationError
ClientError <|-- AuthenticationError
ServerError <|-- DatabaseError
ServerError <|-- ExternalServiceError
```

**Diagram sources**
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L35)
- [middleware.ts](file://middleware.ts#L25)
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L130)

**Section sources**
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L35)
- [middleware.ts](file://middleware.ts#L25)
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L130)

## 错误监控与追踪建议

### 集成第三方监控服务
建议集成 Sentry 等错误监控服务，实现：

```mermaid
graph LR
A[前端应用] --> B[Sentry SDK]
C[API路由] --> B
D[调度器] --> B
B --> E[Sentry服务]
E --> F[错误聚合]
F --> G[通知团队]
G --> H[修复问题]
H --> I[部署修复]
I --> A
```

**Diagram sources**
- [lib/scheduler.ts](file://lib/scheduler.ts#L82)
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L129)

### 用户友好的错误消息
系统应为不同类型的错误提供清晰的用户可读消息：

| 错误类型 | HTTP状态码 | 用户消息 | 开发者信息 |
|---------|----------|--------|----------|
| 输入验证失败 | 400 | "请检查输入内容并重试" | Zod验证错误详情 |
| 未授权访问 | 401 | "请登录后重试" | JWT验证失败原因 |
| 资源未找到 | 404 | "请求的资源不存在" | 请求路径和参数 |
| 内部服务器错误 | 500 | "服务暂时不可用，请稍后重试" | 完整错误堆栈 |

**Section sources**
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L35)
- [middleware.ts](file://middleware.ts#L25)
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts#L130)

## 结论
当前系统的错误处理机制已具备基本功能，但在标准化和可观测性方面仍有改进空间。建议实施全局错误处理中间件，统一错误响应格式，采用结构化日志记录，并集成专业的错误监控服务。这些改进将显著提高系统的可维护性，加快问题诊断速度，并为用户提供更好的错误体验。