# 推送订阅管理

<cite>
**本文档引用的文件**
- [public/sw.js](file://public/sw.js)
- [app/api/push/subscribe/route.ts](file://app/api/push/subscribe/route.ts)
- [app/api/push/vapid-public-key/route.ts](file://app/api/push/vapid-public-key/route.ts)
- [lib/web-push.ts](file://lib/web-push.ts)
- [components/ServiceWorkerRegistration.tsx](file://components/ServiceWorkerRegistration.tsx)
- [components/NotificationPermissionPrompt.tsx](file://components/NotificationPermissionPrompt.tsx)
- [prisma/schema.prisma](file://prisma/schema.prisma)
- [lib/prisma.ts](file://lib/prisma.ts)
- [lib/auth.ts](file://lib/auth.ts)
- [lib/scheduler.ts](file://lib/scheduler.ts)
- [app/settings/page.tsx](file://app/settings/page.tsx)
- [docs/WEB_PUSH_DEBUG.md](file://docs/WEB_PUSH_DEBUG.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

本文件详细说明了Web推送订阅的完整流程，从前端通过navigator.serviceWorker.register激活public/sw.js开始，到Service Worker的install与activate生命周期处理，再到通过PushManager.subscribe发起订阅请求获取PushSubscription对象。文档涵盖了后端如何接收并持久化存储订阅信息、验证订阅数据有效性、用户权限请求流程、订阅更新机制、取消订阅时的数据清理策略，以及浏览器兼容性问题和常见错误处理。

## 项目结构

该项目采用Next.js框架构建，推送订阅功能分布在以下关键目录中：

```mermaid
graph TB
subgraph "前端组件"
A[ServiceWorkerRegistration.tsx]
B[NotificationPermissionPrompt.tsx]
C[settings/page.tsx]
end
subgraph "服务端API"
D[push/subscribe/route.ts]
E[push/vapid-public-key/route.ts]
end
subgraph "核心库"
F[web-push.ts]
G[prisma.ts]
H[auth.ts]
I[scheduler.ts]
end
subgraph "服务端资源"
J[sw.js]
K[schema.prisma]
end
A --> J
B --> D
C --> D
D --> G
D --> H
E --> F
F --> I
G --> K
```

**图表来源**
- [components/ServiceWorkerRegistration.tsx](file://components/ServiceWorkerRegistration.tsx#L1-L30)
- [components/NotificationPermissionPrompt.tsx](file://components/NotificationPermissionPrompt.tsx#L1-L77)
- [app/api/push/subscribe/route.ts](file://app/api/push/subscribe/route.ts#L1-L96)
- [lib/web-push.ts](file://lib/web-push.ts#L1-L54)

**章节来源**
- [components/ServiceWorkerRegistration.tsx](file://components/ServiceWorkerRegistration.tsx#L1-L30)
- [app/api/push/subscribe/route.ts](file://app/api/push/subscribe/route.ts#L1-L96)
- [lib/web-push.ts](file://lib/web-push.ts#L1-L54)

## 核心组件

### Service Worker核心功能

Service Worker作为推送通知的核心执行环境，负责处理安装、激活和推送事件：

- **安装阶段**: 跳过等待期，确保快速激活
- **激活阶段**: 获取所有客户端控制权
- **推送处理**: 解析JSON负载，显示通知
- **点击处理**: 处理通知点击事件，打开目标URL
- **关闭处理**: 记录通知关闭事件

### 订阅管理API

后端提供完整的订阅管理接口：

- **POST /api/push/subscribe**: 创建新的推送订阅
- **DELETE /api/push/subscribe**: 删除现有推送订阅
- **GET /api/push/vapid-public-key**: 获取VAPID公钥

### VAPID认证系统

使用web-push库实现VAPID（Vectorized Application Identifier）认证：

- 支持基于JWT的服务器身份验证
- 提供公私钥对用于消息签名
- 确保推送消息的安全传输

**章节来源**
- [public/sw.js](file://public/sw.js#L1-L78)
- [app/api/push/subscribe/route.ts](file://app/api/push/subscribe/route.ts#L1-L96)
- [lib/web-push.ts](file://lib/web-push.ts#L1-L54)

## 架构概览

推送订阅系统的整体架构分为三层：前端交互层、服务端API层和数据存储层。

```mermaid
sequenceDiagram
participant Client as "客户端浏览器"
participant SW as "Service Worker"
participant API as "Next.js API"
participant DB as "PostgreSQL数据库"
participant VAPID as "VAPID认证"
Client->>Client : 注册Service Worker
Client->>SW : install事件
SW->>SW : skipWaiting()
Client->>SW : activate事件
SW->>SW : clients.claim()
Client->>Client : 请求通知权限
Client->>API : GET /api/push/vapid-public-key
API->>VAPID : 获取公钥
VAPID-->>API : 返回公钥
API-->>Client : 公钥响应
Client->>Client : PushManager.subscribe()
Client->>API : POST /api/push/subscribe
API->>DB : 验证用户并保存订阅
DB-->>API : 订阅已保存
API-->>Client : 订阅成功
Note over Client,DB : 后续推送流程
DB->>API : 获取用户订阅列表
API->>VAPID : 使用VAPID签名发送推送
VAPID->>Client : 推送消息
Client->>SW : push事件
SW->>Client : 显示通知
```

**图表来源**
- [components/ServiceWorkerRegistration.tsx](file://components/ServiceWorkerRegistration.tsx#L10-L25)
- [components/NotificationPermissionPrompt.tsx](file://components/NotificationPermissionPrompt.tsx#L51-L73)
- [app/api/push/subscribe/route.ts](file://app/api/push/subscribe/route.ts#L14-L62)
- [lib/web-push.ts](file://lib/web-push.ts#L28-L46)

## 详细组件分析

### Service Worker生命周期管理

Service Worker的生命周期包括三个关键阶段：

#### 安装阶段（Install）
- 跳过等待期，立即激活新版本
- 确保用户能够立即获得最新的推送功能

#### 激活阶段（Activate）
- 获取所有客户端的控制权
- 清理旧的缓存资源
- 准备处理推送事件

#### 推送事件处理
- 解析推送负载的JSON格式
- 提供默认通知配置
- 支持自定义通知参数

```mermaid
flowchart TD
Start([Service Worker启动]) --> Install["install事件<br/>skipWaiting()"]
Install --> Activate["activate事件<br/>clients.claim()"]
Activate --> PushEvent["push事件<br/>解析负载"]
PushEvent --> ShowNotification["showNotification()<br/>显示通知"]
ShowNotification --> ClickEvent["notificationclick事件<br/>处理点击"]
ClickEvent --> CloseEvent["notificationclose事件<br/>记录关闭"]
CloseEvent --> End([完成])
```

**图表来源**
- [public/sw.js](file://public/sw.js#L2-L10)
- [public/sw.js](file://public/sw.js#L12-L49)
- [public/sw.js](file://public/sw.js#L51-L77)

**章节来源**
- [public/sw.js](file://public/sw.js#L1-L78)

### 用户权限请求流程

权限请求流程确保用户体验和浏览器安全策略的平衡：

```mermaid
flowchart TD
PageLoad[页面加载完成] --> CheckSupport["检查浏览器支持<br/>Notification & ServiceWorker"]
CheckSupport --> CheckPermission["检查当前权限状态"]
CheckPermission --> IsDefault{"权限状态为default?"}
IsDefault --> |否| SkipPrompt["跳过自动提示"]
IsDefault --> |是| DelayPrompt["延迟2秒后提示"]
DelayPrompt --> RequestPermission["requestPermission()"]
RequestPermission --> PermissionResult{"权限结果"}
PermissionResult --> |granted| AutoSubscribe["自动订阅推送"]
PermissionResult --> |denied| ShowMessage["显示阻止消息"]
PermissionResult --> |default| Continue["继续等待"]
AutoSubscribe --> SaveSubscription["保存订阅到服务器"]
SaveSubscription --> Complete[完成]
SkipPrompt --> Complete
ShowMessage --> Complete
```

**图表来源**
- [components/NotificationPermissionPrompt.tsx](file://components/NotificationPermissionPrompt.tsx#L9-L49)
- [components/NotificationPermissionPrompt.tsx](file://components/NotificationPermissionPrompt.tsx#L51-L73)

**章节来源**
- [components/NotificationPermissionPrompt.tsx](file://components/NotificationPermissionPrompt.tsx#L1-L77)

### 订阅创建与验证机制

订阅创建过程包含多层验证和安全检查：

#### 前端订阅创建
- 获取VAPID公钥
- 配置userVisibleOnly模式
- 发送订阅请求到服务器

#### 后端验证流程
- JWT令牌验证
- 订阅数据结构验证
- 重复订阅检测
- 数据库持久化

```mermaid
sequenceDiagram
participant Client as "客户端"
participant API as "订阅API"
participant Auth as "认证模块"
participant Schema as "数据验证"
participant DB as "数据库"
Client->>API : POST /api/push/subscribe
API->>Auth : 验证JWT令牌
Auth-->>API : 用户ID有效
API->>Schema : 验证订阅数据
Schema-->>API : 数据格式正确
API->>DB : 检查重复订阅
DB-->>API : 无重复
API->>DB : 创建订阅记录
DB-->>API : 订阅已创建
API-->>Client : 返回订阅信息
```

**图表来源**
- [app/api/push/subscribe/route.ts](file://app/api/push/subscribe/route.ts#L14-L62)
- [lib/auth.ts](file://lib/auth.ts#L22-L29)

**章节来源**
- [app/api/push/subscribe/route.ts](file://app/api/push/subscribe/route.ts#L1-L96)
- [lib/auth.ts](file://lib/auth.ts#L1-L30)

### VAPID认证配置

VAPID（Vectorized Application Identifier）为推送消息提供服务器身份验证：

#### 配置结构
- **公钥**: 用于客户端订阅配置
- **私钥**: 用于消息签名
- **主题**: 用于标识应用

#### 认证流程
- 客户端获取公钥
- 服务器使用私钥签名消息
- 客户端验证消息完整性

```mermaid
classDiagram
class VAPIDConfig {
+string vapidPublicKey
+string vapidPrivateKey
+string vapidSubject
+setVapidDetails() void
+getVapidPublicKey() string
}
class PushSubscription {
+string endpoint
+string p256dh
+string auth
+string userId
}
class PushPayload {
+string title
+string body
+any data
}
VAPIDConfig --> PushPayload : "签名消息"
PushSubscription --> VAPIDConfig : "使用公钥"
```

**图表来源**
- [lib/web-push.ts](file://lib/web-push.ts#L5-L15)
- [lib/web-push.ts](file://lib/web-push.ts#L17-L23)

**章节来源**
- [lib/web-push.ts](file://lib/web-push.ts#L1-L54)

### 订阅数据模型

推送订阅使用Prisma ORM进行数据持久化，支持复杂查询和关系管理：

#### 数据模型结构
- **用户关联**: 每个订阅都绑定到特定用户
- **端点唯一性**: 同一用户在同一端点只能有一个订阅
- **密钥存储**: 存储加密所需的p256dh和auth密钥

#### 查询优化
- 基于用户ID和端点的复合索引
- 支持批量删除无效订阅
- 自动清理过期或无效的订阅

**章节来源**
- [prisma/schema.prisma](file://prisma/schema.prisma#L76-L85)
- [lib/prisma.ts](file://lib/prisma.ts#L1-L20)

### 推送发送与清理机制

系统实现了智能的推送发送和订阅清理机制：

#### 推送发送流程
- 获取用户所有订阅
- 逐个发送推送消息
- 处理410 Gone错误
- 自动删除无效订阅

#### 错误处理策略
- 记录发送失败原因
- 检测订阅失效状态
- 实时清理无效订阅
- 继续发送给其他有效订阅

```mermaid
flowchart TD
Start([开始推送]) --> GetSubscriptions["获取用户订阅列表"]
GetSubscriptions --> LoopSubscriptions{"还有订阅吗?"}
LoopSubscriptions --> |是| SendPush["发送推送消息"]
SendPush --> CheckResult{"发送成功?"}
CheckResult --> |是| CountSuccess["计数+1"]
CheckResult --> |否| CheckError{"错误类型"}
CheckError --> |410 Gone| DeleteInvalid["删除无效订阅"]
CheckError --> |其他错误| LogError["记录错误"]
DeleteInvalid --> LoopSubscriptions
LogError --> LoopSubscriptions
CountSuccess --> LoopSubscriptions
LoopSubscriptions --> |否| MarkSent["标记任务已发送"]
MarkSent --> End([结束])
```

**图表来源**
- [lib/scheduler.ts](file://lib/scheduler.ts#L42-L73)

**章节来源**
- [lib/scheduler.ts](file://lib/scheduler.ts#L40-L86)

## 依赖关系分析

推送订阅系统涉及多个模块间的复杂依赖关系：

```mermaid
graph TB
subgraph "前端层"
A[ServiceWorkerRegistration]
B[NotificationPermissionPrompt]
C[Settings Page]
end
subgraph "API层"
D[Push Subscribe Route]
E[VAPID Public Key Route]
end
subgraph "核心库"
F[Web Push Library]
G[Prisma Client]
H[Auth Module]
end
subgraph "数据层"
I[PushSubscription Model]
J[User Model]
end
A --> D
B --> D
C --> D
D --> F
D --> G
D --> H
E --> F
F --> I
G --> I
I --> J
```

**图表来源**
- [components/ServiceWorkerRegistration.tsx](file://components/ServiceWorkerRegistration.tsx#L1-L30)
- [app/api/push/subscribe/route.ts](file://app/api/push/subscribe/route.ts#L1-L96)
- [lib/web-push.ts](file://lib/web-push.ts#L1-L54)

**章节来源**
- [components/ServiceWorkerRegistration.tsx](file://components/ServiceWorkerRegistration.tsx#L1-L30)
- [app/api/push/subscribe/route.ts](file://app/api/push/subscribe/route.ts#L1-L96)
- [lib/web-push.ts](file://lib/web-push.ts#L1-L54)

## 性能考虑

### 订阅管理性能优化

1. **重复订阅检测**: 在数据库层面避免重复存储相同端点的订阅
2. **批量操作**: 支持批量删除无效订阅，减少数据库往返
3. **异步处理**: 推送发送采用异步方式，避免阻塞主线程

### 内存和资源管理

1. **Service Worker生命周期**: 合理管理内存使用，避免长时间占用
2. **通知资源**: 控制通知图标和媒体资源大小
3. **网络请求**: 优化VAPID公钥获取和订阅创建的网络请求

## 故障排除指南

### 常见浏览器兼容性问题

#### Safari浏览器问题
- 需要macOS 13+或iOS 16.4+支持
- 权限请求需要直接用户手势触发
- 可能需要手动在设置中启用通知

#### Chrome和Firefox问题
- 确保HTTPS环境
- 检查Service Worker支持
- 验证VAPID密钥配置

### 权限相关错误

#### NotAllowedError处理
- 检查浏览器是否支持通知API
- 验证HTTPS环境
- 确认用户手势触发权限请求

#### Permission状态检查
- 使用`Notification.permission`检查当前状态
- 处理`denied`状态下的用户引导
- 提供手动设置指引

### VAPID配置问题

#### 密钥配置错误
- 确认环境变量设置正确
- 验证公私钥匹配
- 检查VAPID主题格式

#### 推送发送失败
- 检查订阅端点有效性
- 验证VAPID签名
- 查看服务器日志

**章节来源**
- [docs/WEB_PUSH_DEBUG.md](file://docs/WEB_PUSH_DEBUG.md#L1-L61)
- [components/NotificationPermissionPrompt.tsx](file://components/NotificationPermissionPrompt.tsx#L91-L122)

## 结论

推送订阅管理系统提供了完整的Web推送通知解决方案，包括：

1. **完整的生命周期管理**: 从Service Worker注册到推送事件处理
2. **严格的安全验证**: JWT令牌验证和VAPID认证双重保障
3. **智能的订阅管理**: 自动检测重复订阅和清理无效订阅
4. **良好的用户体验**: 平滑的权限请求流程和错误处理
5. **完善的错误处理**: 全面的故障排除和调试支持

该系统为用户提供可靠的推送通知体验，同时为开发者提供了清晰的扩展和维护路径。通过合理的架构设计和严格的验证机制，确保了系统的稳定性和安全性。