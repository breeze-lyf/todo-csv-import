# 开发指南

<cite>
**本文档引用文件**  
- [vitest.config.ts](file://vitest.config.ts)
- [tests/setup.ts](file://tests/setup.ts)
- [eslint.config.mjs](file://eslint.config.mjs)
- [.cursorrules](file://.cursorrules)
- [package.json](file://package.json)
- [README.md](file://README.md)
- [app/api/events/route.ts](file://app/api/events/route.ts)
- [app/api/events/bulk-create/route.ts](file://app/api/events/bulk-create/route.ts)
- [lib/prisma.ts](file://lib/prisma.ts)
- [middleware.ts](file://middleware.ts)
- [docs/PRD.md](file://docs/PRD.md)
- [docs/NEW_FEATURES_GUIDE.md](file://docs/NEW_FEATURES_GUIDE.md)
</cite>

## 目录
1. [简介](#简介)
2. [本地开发与调试](#本地开发与调试)
3. [测试策略](#测试策略)
4. [代码质量标准](#代码质量标准)
5. [贡献流程](#贡献流程)
6. [新功能开发工作流](#新功能开发工作流)

## 简介

本开发指南旨在为贡献者提供全面的开发支持，涵盖本地调试、测试策略、代码质量、贡献流程及新功能开发的完整周期。项目为人力外包行业设计的全栈日历提醒应用，采用 Next.js 14 (App Router) + TypeScript + TailwindCSS 技术栈，支持批量 CSV 导入、Web Push 通知与提醒规则系统。

**本文档引用文件**  
- [README.md](file://README.md)
- [package.json](file://package.json)

## 本地开发与调试

### 调试技巧

本地开发环境使用 `pnpm dev` 启动，服务运行在 `http://localhost:3000`。调试时建议结合 `console.log` 与浏览器开发者工具进行问题定位。

- **前端调试**：在 React 组件或客户端逻辑中插入 `console.log` 输出状态、props 或 API 响应，通过浏览器控制台查看。
- **API 路由调试**：在 `/app/api` 下的路由处理函数中使用 `console.log` 输出请求体、认证信息或数据库查询结果。
- **中间件调试**：`middleware.ts` 中的认证逻辑可通过日志确认 token 验证流程与重定向行为。
- **Prisma 调试**：在数据库操作前后输出查询参数与结果，确保数据隔离（仅当前用户数据）。

**Section sources**  
- [middleware.ts](file://middleware.ts#L5-L45)
- [app/api/events/route.ts](file://app/api/events/route.ts#L15-L200)

## 测试策略

### Vitest 配置

项目使用 Vitest 作为测试框架，配置文件 `vitest.config.ts` 定义了测试环境与别名：

- **测试环境**：`environment: 'node'`，适用于 API 与工具函数测试。
- **全局变量**：`globals: true`，启用全局测试 API（如 `describe`、`test`）。
- **初始化文件**：`setupFiles: ['./tests/setup.ts']`，在每个测试文件前执行。
- **路径别名**：`@` 指向项目根目录，便于模块导入。

**Section sources**  
- [vitest.config.ts](file://vitest.config.ts#L1-L16)

### 测试初始化逻辑

`tests/setup.ts` 文件负责测试环境的初始化：

- 引入 `@testing-library/jest-dom` 以支持 DOM 断言。
- 使用 `vi`（Vitest 的 mock 工具）进行依赖模拟。
- 模拟环境变量，如 `process.env.JWT_SECRET = 'test-secret'`，确保认证逻辑可测试。

该文件确保所有测试在一致、隔离的环境中运行，避免副作用。

**Section sources**  
- [tests/setup.ts](file://tests/setup.ts#L1-L6)

### 测试覆盖

项目已实现核心业务逻辑的全覆盖，包括：

- 用户认证流程（注册、登录、登出）
- 事件的增删改查与批量导入
- 提醒规则与 Web Push 通知
- 搜索与筛选功能

测试文件位于 `__tests__` 目录，遵循 TDD 原则，先编写失败测试再实现功能。

**Section sources**  
- [README.md](file://README.md#L87-L90)
- [docs/PRD.md](file://docs/PRD.md#L120-L193)

## 代码质量标准

### ESLint 配置

代码质量由 ESLint 保证，配置文件 `eslint.config.mjs` 基于 `eslint-config-next`，包含：

- **核心规则**：继承自 `nextVitals` 和 `nextTs`，确保 Next.js 最佳实践与 TypeScript 类型安全。
- **忽略规则**：明确忽略 `.next/**`、`out/**`、`build/**` 等构建目录，避免误报。

该配置强制使用严格模式，提升代码可维护性。

**Section sources**  
- [eslint.config.mjs](file://eslint.config.mjs#L1-L19)

### AI 辅助开发规范

`.cursorrules` 文件定义了 AI 辅助开发的全局规则，确保技术栈一致性与安全性：

- **技术栈强制**：必须使用 Next.js 14 (App Router)、Prisma + PostgreSQL、TypeScript、TailwindCSS。
- **架构规则**：严禁在前端直接操作数据库，所有持久化操作必须通过 API 路由。
- **安全要求**：密码必须哈希存储，JWT 使用 httpOnly Cookie，防止 XSS 与 IDOR。
- **CSV 导入**：前端解析 CSV，后端批量插入，支持中英文列名别名。
- **测试规则**：优先使用 Vitest，关键路径必须覆盖认证、权限隔离与错误处理。

这些规则确保代码风格统一、架构清晰、安全可靠。

**Section sources**  
- [.cursorrules](file://.cursorrules#L1-L240)

## 贡献流程

### 分支管理

采用基于主干的开发模式：

- `main` 分支为生产环境，受保护。
- 新功能或修复在 `feature/xxx` 或 `fix/xxx` 分支开发。
- 完成后提交 Pull Request 至 `main`。

### 代码提交规范

提交信息应遵循 [Conventional Commits](https://www.conventionalcommits.org/) 规范：

- `feat: ` 新功能
- `fix: ` 修复缺陷
- `docs: ` 文档更新
- `test: ` 测试相关
- `chore: ` 构建或工具变更

示例：`feat: implement bulk CSV import with preview`

### Pull Request 审查要求

PR 必须满足以下条件方可合并：

- 通过 CI/CD 流水线（包括 lint、test）
- 代码符合 `.cursorrules` 与 ESLint 规则
- 新功能有对应测试覆盖
- 文档（如 `docs/`）已更新
- 至少一名核心成员批准

**Section sources**  
- [README.md](file://README.md#L92-L106)
- [.cursorrules](file://.cursorrules#L155-L162)

## 新功能开发工作流

推荐采用垂直切片（vertical slice）方式开发新功能，从需求到测试完整闭环。

### 1. 需求分析

参考 `docs/PRD.md` 明确用户故事与验收标准。例如，实现“长按创建事件”需满足：

- 移动端长按触发
- 桌面端右键触发
- 自动填充日期

**Section sources**  
- [docs/PRD.md](file://docs/PRD.md#L126-L133)

### 2. 架构设计

定义前后端组件：

- **前端**：`EventDialog.tsx` 复用对话框，`page.tsx` 添加长按/右键事件监听。
- **后端**：复用 `/api/events` POST 路由。
- **数据**：Prisma `Event` 模型。

### 3. 任务拆解

按垂直切片拆解任务：

- 实现长按/右键交互逻辑
- 连接 API 创建事件
- 添加测试验证功能

### 4. 编码与测试

- 先编写失败测试（Red），如“长按应打开对话框”。
- 实现功能（Green），确保测试通过。
- 代码提交前运行 `pnpm lint` 与 `pnpm test`。

### 5. 文档更新

在 `docs/NEW_FEATURES_GUIDE.md` 中添加使用说明，如：

```markdown
## 📱 长按/右键快速创建事件
1. **长按**日历日期格子
2. 填写信息并保存
```

**Section sources**  
- [docs/NEW_FEATURES_GUIDE.md](file://docs/NEW_FEATURES_GUIDE.md#L56-L78)
- [app/page.tsx](file://app/page.tsx)